import{d as ee,r as _,y as te,o as re,c as ne,w as V,$ as oe,F as ie,a as I,z as j,Q as ae,R as J}from"./index.02f7c95d.js";import{u as le}from"./use-quasar.2d4ce40a.js";import ce from"./ATitleBar.bbf1d9a4.js";import se from"./TabulatorGrid.9c80b09d.js";import{api as v}from"./axios.816e1a60.js";import{g as w}from"./header.10137493.js";import E from"./ABtn.e24d7e8a.js";import de from"./BoardCategoryMovePopup.1a199b96.js";import{u as L}from"./use-dialog-plugin-component.234e0905.js";import{s as p,a as ue}from"./dialog.88ce899f.js";import{h as P}from"./errorHandler.5efe1eb1.js";import{_ as fe}from"./_plugin-vue_export-helper.cdc0426e.js";const he=(o,t)=>{let a=o?`/rest/api/v1/board/categories/${o}`:"/rest/api/v1/board/categories";return typeof t!="undefined"&&(a+=`?isTopCode=${t}`),v.get(a,w())},ge=(o,t,a,i)=>v.post("/rest/api/v1/board/categories",{entity:{code:o,name:t,orderNumber:i,parent:{entityId:a}}},w()),me=(o,t,a,i,l)=>{const s={code:t,name:a,orderNumber:l};return i&&(s.parent={entityId:i}),v.put(`/rest/api/v1/board/categories/${o}`,{entity:s},w())},ye=o=>v.post("/rest/api/v1/board/categories/multiple",{entities:o},w()),pe=o=>v.put("/rest/api/v1/board/categories/multiple",{entities:o},w()),Ce=o=>v.delete(`/rest/api/v1/board/categories/${o}`,w()),Ie=o=>{const t=o.join(",");return v.delete("/rest/api/v1/board/categories",{...w(),params:{entityIds:t}})},b={getCategory:he,saveCategory:ge,saveMultipleCategories:ye,updateMultipleCategories:pe,updateCategory:me,deleteCategory:Ce,deleteMultipleCategories:Ie},ve=ee("categoryStore",{state:()=>({categories:new Map,categoryArray:[],recid:1}),getters:{getCategory:o=>(t,a)=>{if(!t)return null;let i=Array.isArray(t)?t:t.children;return i!=null&&i.length&&i.find(l=>l.code===a)||null},getCategoryName:o=>(t,a)=>{if(!t)return null;let i=Array.isArray(t)?t:t.children;if(!(i!=null&&i.length))return null;const l=i.find(s=>s.code===a);return l?l.name:null},getCategoryByEntityId:o=>(t,a)=>{if(!t)return null;let i=Array.isArray(t)?t:t.children;return i!=null&&i.length&&i.find(l=>l.entityId===a)||null},getChildrencategoriesByTopParentCodeValue:o=>t=>{const a=o.categories.get(t);return(a==null?void 0:a.children)||[]},getChildrenCategoryNamesByTopParentCodeValue:o=>t=>{var i;const a=o.categories.get(t);return((i=a==null?void 0:a.children)==null?void 0:i.map(l=>l.name))||[]},findcategoriesInTopParentCodeValue:o=>(t,a,i)=>{function l(y,d,m){!(d!=null&&d.children)||d.children.forEach(u=>{u.code===m&&y.push(u),l(y,u,m)})}const s=[],h=o.categories.get(t);return h&&l(s,h,a),i?s[0]||null:s},findCategoryNamesInTopParentCodeValue:o=>(t,a,i)=>{function l(y,d,m){!(d!=null&&d.children)||d.children.forEach(u=>{u.code===m&&y.push(u.name),l(y,u,m)})}const s=[],h=o.categories.get(t);return h&&l(s,h,a),i?s[0]||null:s},findParentCategoryByChildren:o=>t=>{if(!(t!=null&&t.parentEntityId))return o.categoryArray;let a=null;function i(l){l.forEach(s=>{var h;t.parentEntityId===s.entityId?a=s.children||[]:(h=s.children)!=null&&h.length&&i(s.children)})}return i(o.categoryArray),a||o.categoryArray},findParentCode:o=>t=>{if(!(t!=null&&t.parentEntityId))return null;let a=null;function i(l){l.forEach(s=>{t.parentEntityId===s.entityId?a=s:s.children&&s.children.length>0&&i(s.children)})}return i(o.categoryArray),a},findIndexInParentCategoryChildren:o=>(t,a)=>t.findIndex(i=>i.entityId===a.entityId)},actions:{setcategories(o){this.categories=new Map,o.forEach(t=>{var a;(a=t.children)!=null&&a.length&&t.children.sort((i,l)=>i.orderNumber!==l.orderNumber?i.orderNumber-l.orderNumber:i.name.localeCompare(l.name)),this.categories.set(t.code,t)})},setcategoryArray(o){this.recid=1;const t=(a,i)=>{a.sort((l,s)=>l.orderNumber!==s.orderNumber?l.orderNumber-s.orderNumber:l.name.localeCompare(s.name)),a.forEach(l=>{var s;l.recid=this.recid++,l.remarkText||(l.remarkText=""),i&&(l.parentCode=i.code,l.parentEntityId=i.entityId,l.parentRecid=i.recid,l.prevParentEntityId=i.entityId),(s=l.children)!=null&&s.length&&t(l.children,l)})};this.categoryArray=o,t(this.categoryArray)},load(){b.getCategory(null,!1).then(o=>{o.status===200&&this.setcategories(o.data)}).catch(o=>{console.log(o)}),b.getCategory(null).then(o=>{o.status===200&&this.setcategoryArray(o.data)}).catch(o=>{console.log(o)})},clear(){this.setcategories([]),this.setcategoryArray([])},async save(o){try{const t=await b.saveMultipleCategories(o);return t.status===200&&this.load(),t}catch(t){throw console.log(t),t}},async update(o){try{const t=await b.updateMultipleCategories(o);return t.status===200&&this.load(),t}catch(t){throw console.log(t),t}},async remove(o){try{const t=await b.deleteCategory(o);return t.status===200&&this.load(),t}catch(t){throw console.log(t),t}},search(o={}){return new Promise(t=>{if(!o.name&&!o.code){t([]);return}const a=i=>i.reduce((l,s)=>{var m;const h={...s},y=!o.code||h.code.includes(o.code),d=!o.name||h.name.includes(o.name);return y&&d&&l.push(h),(m=h.children)!=null&&m.length&&l.push(...a(h.children)),l},[]);t(a(this.categoryArray))})}}});const we={class:"q-pa-xs column col full-width no-wrap"},be={class:"col-auto full-width text-right bg-grey-5 a-border q-pa-xs no-wrap"},Ne={__name:"BoardCatagoryManagePopup",emits:["close","callback",...L.emits],setup(o,{emit:t}){const a=ve(),i=le(),{dialogRef:l,onDialogOK:s,onDialogHide:h}=L(),y=[{title:"\uCE74\uD14C\uACE0\uB9AC\uBA85",field:"name",hozAlign:"left",headerHozAlign:"center",headerSort:!1,editor:"input",cellEdited:function(r){const e=r.getRow().getData();e._isModified=!0}}],d=_([]),m=_([]),u=_([]);te(()=>S());function K(){if(!u.value.length){p("\uCE74\uD14C\uACE0\uB9AC\uB97C \uC120\uD0DD\uD574\uC8FC\uC138\uC694.");return}const r=u.value[0];i.dialog({component:de,componentProps:{categoryList:d.value}}).onOk(e=>{const n=e.parentEntityId;if(r.entityId===n){p("\uC790\uAE30 \uC790\uC2E0\uC744 \uC0C1\uC704 \uCF54\uB4DC\uB85C \uC120\uD0DD\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}if(A(r.children||[],n)){p("\uC790\uC2E0\uC758 \uD558\uC704 \uCF54\uB4DC\uB97C \uC0C1\uC704 \uCF54\uB4DC\uB85C \uC120\uD0DD\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}r.parentEntityId=n,r._isModified=!0,O(r,n)}).onCancel(()=>{}).onDismiss(()=>{})}function O(r,e){M(r,d.value),R(r,e,d.value)}function M(r,e){for(let n=0;n<e.length;n++){const c=e[n];if(c.code===r.code)return e.splice(n,1),e.length&&N(e),!0;if(c.children&&c.children.length>0&&M(r,c.children))return!0}return!1}function R(r,e,n){for(const c of n){if(c.entityId===e)return c.children||(c.children=[]),c.children.push(r),N(c.children),!0;if(c.children&&c.children.length>0&&R(r,e,c.children))return!0}return!1}function A(r,e){for(const n of r){if(n.entityId===e)return!0;if(n.children&&n.children.length>0&&A(n.children,e))return!0}return!1}function D(r){return r.map(e=>{var n;return(n=e.children)!=null&&n.length&&(e.children=D(e.children)),e}).sort((e,n)=>e.orderNumber-n.orderNumber)}function U(r){const n=[{entityId:"",name:"\uC804\uCCB4",code:"",path:null,orderNumber:0,children:JSON.parse(JSON.stringify(r))}];return B(n),k(n)}function B(r){return r.map(e=>(e.children&&!e.children.length&&delete e.children,e.children&&(e.children=B(e.children)),e))}function k(r){return r.map(e=>{var c;const n={...e,id:e.code};return(c=n.children)!=null&&c.length&&(n.children=k(n.children)),n})}function S(){b.getCategory().then(r=>{const e=D(r.data);d.value=U(e)}).catch(r=>{P(r)})}async function W(){const r=m.value.getData(),e=[],n=[],c=[];function g(C){C.forEach((f,T)=>{var Q;let F=null;f.parentEntityId&&(F={entityId:f.parentEntityId});const x={code:f.code,name:f.name,orderNumber:T+1,parent:F};if(((Q=f.name)==null?void 0:Q.length)>1024){c.push(f);return}(!f.entityId||f.entityId==="")&&f.name!=="\uC804\uCCB4"?e.push(x):f.entityId&&f._isModified&&(x.entityId=f.entityId,n.push(x)),f.children&&f.children.length>0&&g(f.children)})}if(g(r),c.length>0){p("\uCE74\uD14C\uACE0\uB9AC \uC774\uB984\uC740 1024\uC790\uB97C \uCD08\uACFC\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}try{n.length>0&&await a.update(n),e.length>0&&await a.save(e),s(),p("\uCE74\uD14C\uACE0\uB9AC\uAC00 \uC131\uACF5\uC801\uC73C\uB85C \uC800\uC7A5\uB418\uC5C8\uC2B5\uB2C8\uB2E4.")}catch(C){P(C)}}function G(){return"CT_"+Date.now()+"_"+Math.floor(Math.random()*1e3)}function X(){const r="\uC0C8 \uCE74\uD14C\uACE0\uB9AC";let e=0;function n(c){c.forEach(g=>{const C=g.name.match(new RegExp(`^${r} (\\d+)$`));if(C&&C[1]){const f=parseInt(C[1],10);f>e&&(e=f)}g.children&&g.children.length>0&&n(g.children)})}return n(d.value),`${r} ${e+1}`}function $(r){let e=0;return r&&r.length>0&&r.forEach(n=>{n.orderNumber!=null&&(e=Math.max(e,n.orderNumber))}),e+1}function N(r){r&&r.length>0&&(r.sort((e,n)=>e.orderNumber-n.orderNumber),r.forEach((e,n)=>{const c=n+1;e.orderNumber!==c&&(e._isModified=!0),e.orderNumber=c}))}function Y(){const r={code:G(),name:X()};if(!u.value.length||u.value[0].name==="\uC804\uCCB4"){const e=d.value[0];e.children||(e.children=[]),r.orderNumber=$(e.children),e.children.push(r),J(()=>z(""))}else{const e=u.value[0];if(!e.entityId){p("\uB4F1\uB85D\uB418\uC9C0 \uC54A\uC740 \uCE74\uD14C\uACE0\uB9AC \uD558\uC704\uC5D0 \uCD94\uAC00\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}e.children||(e.children=[]),r.orderNumber=$(e.children);let n=e.entityId;r.parentEntityId=n,e.children.push(r),J(()=>z(e.code))}}function q(r){u.value=r}function H(r,e){for(const n of r){if(n.entityId===e)return n;if(n.children&&n.children.length>0){const c=H(n.children,e);if(c)return c}}return null}function Z(){var e;if(!((e=u.value)!=null&&e.length)){p("\uC0AD\uC81C\uD560 \uCE74\uD14C\uACE0\uB9AC\uB97C \uC120\uD0DD\uD574\uC8FC\uC138\uC694.");return}const r=u.value[0];if(r.entityId===""&&r.name==="\uC804\uCCB4"){p("\uC804\uCCB4\uB294 \uC0AD\uC81C\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}if(r.entityId)ue("\uC120\uD0DD\uD55C \uCE74\uD14C\uACE0\uB9AC\uB97C \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?").then(n=>{n&&a.remove(r.entityId).then(()=>{u.value=[],S()}).catch(c=>{P(c)})});else if(r.parentEntityId){const n=H(d.value,r.parentEntityId),c=n.children.findIndex(g=>g===r);if(c!==-1){n.children.splice(c,1),N(n.children),u.value=[];return}}else{const n=d.value[0],c=n.children.findIndex(g=>g===r);if(c!==-1){n.children.splice(c,1),N(n.children),u.value=[];return}}}_();function z(r){m.value.selectRowByManually(r)}return(r,e)=>(re(),ne(ie,{ref_key:"dialogRef",ref:l,onHide:oe(h),"no-backdrop-dismiss":"","transition-show":"fade","transition-hide":"fade"},{default:V(()=>[I(ae,{class:"dialog-large column no-wrap"},{default:V(()=>[I(ce,{title:"\uCE74\uD14C\uACE0\uB9AC \uAD00\uB9AC",close:!0,class:"col-auto full-width"}),j("div",we,[I(se,{ref_key:"gridRef",ref:m,rows:d.value,columns:y,class:"col full-width",dataTree:!0,dataTreeStartExpanded:!0,"header-visible":!1,reactiveData:!1,selectableRows:1,onRowSelected:q,onRowDeselected:q},null,8,["rows"]),j("div",be,[I(E,{label:"\uCD94\uAC00",onClick:Y}),I(E,{label:"\uC774\uB3D9",class:"q-ml-xs",onClick:K}),I(E,{label:"\uC0AD\uC81C",class:"q-ml-xs",onClick:Z}),I(E,{label:"\uC800\uC7A5",onClick:W,class:"q-ml-xs"})])])]),_:1})]),_:1},8,["onHide"]))}},_e=fe(Ne,[["__scopeId","data-v-7eae830d"]]),He=Object.freeze(Object.defineProperty({__proto__:null,default:_e},Symbol.toStringTag,{value:"Module"}));export{_e as B,He as a,b as c,ve as u};
