import{a as g,Q as U}from"./QTabPanels.3ec79e61.js";import{u as ie}from"./use-quasar.2d4ce40a.js";import _ from"./ATab.766fc7d1.js";import O from"./ATabs.2a11bd5d.js";import ue from"./TicketLogPanel.f99866ed.js";import ce from"./NewTicket.788a9e21.js";import{k as de,r as d,y as re,u as me,t as pe,o as fe,Y as Ce,z as y,a as o,w as r}from"./index.02f7c95d.js";import"./ClosePopup.daa62b28.js";/* empty css                                                             */import{_ as he}from"./_plugin-vue_export-helper.cdc0426e.js";import{t as P}from"./ticketApi.d3774daa.js";import{t as A}from"./ticketChannelApi.1f3fe83b.js";import{u as ve}from"./codeStore.e69f9e04.js";import{u as Te}from"./counselTypeStore.5faa86f9.js";import{u as ye}from"./authStore.fadf8446.js";import Ie from"./UserInfoPanel.317ac832.js";import ge from"./ChampInfoPanel.431ae0d6.js";import{c as _e}from"./customerInfoApi.4e3b1586.js";import ke from"./ReportInfoPanel.2b3c045c.js";import Ee from"./CunstomerSelectionPopup.cdbe0ad2.js";import{s as Ne}from"./dialog.88ce899f.js";import{h as C}from"./errorHandler.5efe1eb1.js";import{F as k}from"./FlowSystemCode.7be7ce49.js";import"./touch.9135741d.js";import"./position-engine.53490cc8.js";import"./QBadge.c1f4e948.js";import"./QResizeObserver.dd2c8de3.js";import"./rtl.276c3f1b.js";import"./TabulatorGrid.9c80b09d.js";import"./QTooltip.86ca1c0e.js";import"./QItem.1bce08e7.js";import"./QList.4c243fc6.js";import"./QMenu.3c9cf304.js";import"./lodash.33ed51ec.js";import"./_commonjsHelpers.c10bf6cb.js";import"./ABtn.e24d7e8a.js";import"./ASelect.a02a29e0.js";import"./QSelect.b17c746f.js";import"./format.2cae61da.js";import"./AInput.398f059b.js";import"./UserPopup.4dc2e487.js";import"./ATitleBar.bbf1d9a4.js";import"./ACheckbox.923db872.js";import"./use-dialog-plugin-component.234e0905.js";import"./organizationStore.a86bd6ff.js";import"./axios.816e1a60.js";import"./header.10137493.js";import"./userApi.abe7b8c8.js";import"./ALoadingSpinner.ca275fb8.js";import"./ATextarea.94103f28.js";/* empty css                                                                  */import"./commandStore.9ed00edb.js";import"./scriptApi.ab757ee5.js";import"./CommonPopup.2b0ee10b.js";import"./counsel-hub.145170b4.js";const Se={class:"row no-wrap fit",style:{"min-height":"880px"}},xe={class:"col full-height column no-wrap"},De={class:"row col-auto q-mb-xs a-border q-pa-xs full-width no-wrap",style:{height:"225px"}},Ve={class:"col-4 q-mr-xs q-pt-xs a-border full-height column"},be={class:"col q-pt-xs a-border full-height column"},Ue={class:"col-auto column full-width no-wrap a-border q-mb-xs q-pt-xs",style:{height:"400px"}},Oe={class:"q-pt-xs col column no-wrap a-border full-width"},Pe={__name:"CallConsult4",setup(Ae){const h=de().appContext.config.globalProperties.$emitter,oe=ie(),E=d("userInfo"),N=d("champInfo"),S=d("reportInfo"),x=d("ticketLog"),v=d([]),I=ve(),q=Te(),w=ye(),D=d(null),F=k.TICKET_TYPE.COUNSEL_TICKET,$=k.TICKET_PROCESS_STATUS.UNPROCESSED,B=k.CHANNEL_TYPE.VOICE,H=k.CHANNEL_CONTACT_TYPE.INBOUND,M=k.CHANNEL_CONTACT_TYPE.OUTBOUND;d({responsive:!0,maintainAspectRatio:!1});const V=d({}),Y=d(null),p=d(),m=d(),K=d(null);re(()=>{window.getTicketData=()=>K.value,h.on("callInStarted",Q),h.on("callOutStarted",z),h.on("callEnded",W),h.on("processEnded",j)}),me(()=>{h.off("callInStarted",Q),h.off("callOutStarted",z),h.off("callEnded",W),h.off("processEnded",j)}),pe(()=>V.value,t=>{t&&L(t.tel)});function L(t){Y.value.getTickets(t)}function b(t){const e=new Date(t),a=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0"),f=String(e.getSeconds()).padStart(2,"0");return`${a}-${s}-${n} ${i}:${l}:${f}`}async function Q(t){const e={},a=t.channelInfo.callInfo;if(!a)return;const s=a.callType;if(!!s){if(s===CounselFlowHubVoiceCode.CallType.CONSULT||s===CounselFlowHubVoiceCode.CallType.CONFERENCE){R(a.xferCallerId),L(a.xferCallerId);return}s===CounselFlowHubVoiceCode.CallType.NORMAL?e.tel=a.callerId:s===CounselFlowHubVoiceCode.CallType.TRANSFER&&(e.tel=a.xferCallerId),e.typeCode=F,e.statusCode=$,e["manager.entityId"]=w.entityId,e.isManualCreated="N",await R(e.tel).then(n=>{n&&(e.customerInfo=n.entityId,e.customerName=n.name),P.saveTicket(e).then(i=>{if(i.status===200){p.value=i.data.entityId,console.log("[\uCD5C\uCD08 \uD2F0\uCF13 \uBC1C\uD589 \uC131\uACF5] : ",p.value);const l={},f=t.channelInfo;l.ticketEntityId=p.value,l.typeCode=B,f.callInfo.extraData.ucid&&(l.extraData=f.callInfo.extraData.ucid),l.contactCode=H,l.startDate=b(t.expiredDate),l.key=a.callId,A.saveTicketChannel(l).then(u=>{u.status===200&&(m.value=u.data.entityId,console.log("[\uD2F0\uCF13 \uCC44\uB110 \uBC1C\uD589] : ",m.value),P.getTicketByEntityId(p.value).then(c=>{c.status===200&&(console.log("[\uD2F0\uCF13 \uC0C1\uC138\uC815\uBCF4 \uC870\uD68C] : ",p.value),V.value=c.data)}).catch(c=>{C(c)}))}).catch(u=>{C(u)})}}).catch(i=>{C(i)})})}}async function z(t){const e={},a=t.channelInfo.callInfo;if(!a)return;const s=a.callType;!s||s===CounselFlowHubVoiceCode.CallType.CONSULT||s===CounselFlowHubVoiceCode.CallType.CONFERENCE||s===CounselFlowHubVoiceCode.CallType.TRANSFER||(e.tel=a.calledId,e.typeCode=F,e.statusCode=$,e["manager.entityId"]=w.entityId,e.isManualCreated="N",await R(e.tel).then(n=>{n&&(e.customerInfo=n.entityId,e.customerName=n.name),P.saveTicket(e).then(i=>{if(i.status===200){p.value=i.data.entityId,console.log("[\uCD5C\uCD08 \uD2F0\uCF13 \uBC1C\uD589 \uC131\uACF5] : ",p.value);const l={},f=t.channelInfo;l.ticketEntityId=p.value,l.typeCode=B,f.callInfo.extraData.ucid&&(l.extraData=f.callInfo.extraData.ucid),l.contactCode=M,l.startDate=b(t.expiredDate),l.key=a.callId,A.saveTicketChannel(l).then(u=>{u.status===200&&(m.value=u.data.entityId,console.log("[\uD2F0\uCF13 \uCC44\uB110 \uBC1C\uD589] : ",m.value),P.getTicketByEntityId(p.value).then(c=>{c.status===200&&(console.log("[\uD2F0\uCF13 \uC0C1\uC138\uC815\uBCF4 \uC870\uD68C] : ",p.value),V.value=c.data)}).catch(c=>{C(c)}))}).catch(u=>{C(u)})}}).catch(i=>{C(i)})}))}function W(t){if(!m.value)return;const e={};e.endDate=b(t.expiredDate),A.updateTicketChannel(m.value,e).then(a=>{a.status===200&&console.log("[\uD2F0\uCF13 \uCC44\uB110 \uC885\uB8CC\uC2DC\uAC04 \uCD94\uAC00] : ",m.value)}).catch(a=>{C(a)})}function j(t){if(!m.value)return;const e={};e.processDate=b(t.expiredDate),A.updateTicketChannel(m.value,e).then(a=>{a.status===200&&(console.log("[\uD2F0\uCF13 \uCC44\uB110 \uD6C4\uCC98\uB9AC\uC2DC\uAC04 \uCD94\uAC00] : ",m.value),m.value=null)}).catch(a=>{C(a)})}async function ne(t){var f,u,c,G,J,X,Z,ee,te,ae;const e={typeCode:((f=I.codes.get(t.typeCode))==null?void 0:f.name)||null,entityId:t.entityId||null,statusCode:((u=I.codes.get(t.statusCode))==null?void 0:u.name)||null,inChannel:null,outChannel:null,counselCategoryCode:((c=I.codes.get(t.counselCategoryCode))==null?void 0:c.name)||null,inboundPath:t.inboundPath||null,counselTypeCodeLarge:((G=q.counselTypes.get(t.counselTypeCodeLarge))==null?void 0:G.name)||null,counselTypeCodeMedium:((J=q.counselTypes.get(t.counselTypeCodeMedium))==null?void 0:J.name)||null,counselTypeCodeSmall:((X=q.counselTypes.get(t.counselTypeCodeSmall))==null?void 0:X.name)||null,contents:t.contents||null,reservationDate:null,reservationTime:null,createdByUserName:t.createdByUserName||null,managerUserName:t.managerUserName||null,createdDate:t.createdDate||null,lastModifiedDate:t.lastModifiedDate||null,customerName:t.customerName||null,tel:t.tel||null,productType:t.productType||null,inquiry:t.inquiry||null};((Z=t.channels)==null?void 0:Z.length)&&t.channels[0].contactCode===H&&(e.inChannel=(ee=I.codes.get(t.channels[0].typeCode))==null?void 0:ee.name),((te=t.channels)==null?void 0:te.length)&&t.channels[0].contactCode===M&&(e.outChannel=(ae=I.codes.get(t.channels[0].typeCode))==null?void 0:ae.name);function a(){if(t.callbackReservationDate){const[T,le]=t.callbackReservationDate.split(" "),se=le?le.substring(0,5):"";e.reservationDate=T,e.reservationTime=se}}a(),K.value=e;const s=t.entityId,n=100*v.value.length,i=100*v.value.length;v.value.forEach(T=>{T.closed||T.focus()});const l=window.open("/view/ticketDetail",s,`width=400,height=730,left=${n},top=${i}`);l?(v.value.push(l),l.addEventListener("unload",()=>{setTimeout(()=>{l.closed&&(v.value=v.value.filter(T=>T!==l))},100)}),l.focus()):console.error("\uD31D\uC5C5\uC774 \uCC28\uB2E8\uB418\uC5C8\uAC70\uB098 \uC5F4\uB9AC\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.")}function R(t){return new Promise((e,a)=>{const s={searchTel:t};_e.getCustomerInfos(s).then(n=>{n.status===200&&(n.data.length===0?(Ne("\uACE0\uAC1D\uC815\uBCF4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."),D.value=null,e(null)):n.data.length===1?(D.value=n.data[0],e(n.data[0])):oe.dialog({component:Ee,componentProps:{customerInfos:n.data}}).onOk(i=>{D.value=i,e(i)}).onCancel(()=>{e(null)}))}).catch(n=>{C(n),a(n)})})}return(t,e)=>(fe(),Ce("div",Se,[y("div",xe,[y("div",De,[y("div",Ve,[o(O,{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=a=>E.value=a),class:"col-auto"},{default:r(()=>[o(_,{name:"userInfo",label:"\uAE30\uBCF8\uC815\uBCF4"})]),_:1},8,["modelValue"]),o(U,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=a=>E.value=a),"keep-alive":"",class:"col"},{default:r(()=>[o(g,{name:"userInfo",class:"q-pa-xs"},{default:r(()=>[o(Ie,{"customer-info":D.value},null,8,["customer-info"])]),_:1})]),_:1},8,["modelValue"])]),y("div",be,[o(O,{modelValue:N.value,"onUpdate:modelValue":e[2]||(e[2]=a=>N.value=a),class:"col-auto"},{default:r(()=>[o(_,{name:"champInfo",label:"\uCC54\uD504\uAE30\uC5C5\uC815\uBCF4"})]),_:1},8,["modelValue"]),o(U,{modelValue:N.value,"onUpdate:modelValue":e[3]||(e[3]=a=>N.value=a),"keep-alive":"",class:"col"},{default:r(()=>[o(g,{name:"champInfo",class:"q-pa-xs"},{default:r(()=>[o(ge)]),_:1})]),_:1},8,["modelValue"])])]),y("div",Ue,[o(O,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=a=>S.value=a),class:"col-auto full-width"},{default:r(()=>[o(_,{name:"reportInfo",label:"\uC2E0\uACE0\uB300\uC0C1 \uC0DD\uD65C\uD654\uD559\uC81C\uD488"}),o(_,{name:"managingInfo",label:"\uC0AC\uD6C4\uAD00\uB9AC \uBAA9\uB85D\uC815\uBCF4"})]),_:1},8,["modelValue"]),o(U,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=a=>S.value=a),"keep-alive":"",class:"col"},{default:r(()=>[o(g,{name:"reportInfo",class:"q-pa-xs"},{default:r(()=>[o(ke)]),_:1}),o(g,{name:"managingInfo",class:"q-pa-xs"})]),_:1},8,["modelValue"])]),y("div",Oe,[o(O,{modelValue:x.value,"onUpdate:modelValue":e[6]||(e[6]=a=>x.value=a),class:"col-auto full-width"},{default:r(()=>[o(_,{name:"ticketLog",label:"\uD2F0\uCF13\uC774\uB825"})]),_:1},8,["modelValue"]),o(U,{modelValue:x.value,"onUpdate:modelValue":e[7]||(e[7]=a=>x.value=a),"keep-alive":"",class:"col"},{default:r(()=>[o(g,{name:"ticketLog",class:"q-pa-xs"},{default:r(()=>[o(ue,{onRowClick:ne,ref_key:"grid",ref:Y},null,512)]),_:1})]),_:1},8,["modelValue"])])]),o(ce,{class:"col-auto full-height","new-ticket":V.value,onUpdate:L},null,8,["new-ticket"])]))}},Lt=he(Pe,[["__scopeId","data-v-867c3eca"]]);export{Lt as default};
