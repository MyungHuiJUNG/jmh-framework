import{g as D,r as p,t as P,y as le,o as z,Y as oe,z as s,a as m,B as ae,c as se,Z as ue,R as ce}from"./index.02f7c95d.js";import{u as de}from"./use-quasar.2d4ce40a.js";import fe from"./AInput.398f059b.js";import me from"./ASelect.a02a29e0.js";import q from"./ABtn.e24d7e8a.js";import pe from"./TabulatorGrid.9c80b09d.js";import{m as I}from"./menuApi.a7c1508d.js";import B from"./ACheckbox.923db872.js";import he from"./MenuPopup.a53a3931.js";import{u as ge}from"./permissionStore.29c18612.js";import{a as L,s as f}from"./dialog.88ce899f.js";import{h as E}from"./errorHandler.5efe1eb1.js";import{F as H}from"./FlowSystemCode.7be7ce49.js";import we from"./ATitleBar.bbf1d9a4.js";import{F as j}from"./FlowRoleCode.12cdb02e.js";import ye from"./ALoadingSpinner.ca275fb8.js";import{_ as ve}from"./_plugin-vue_export-helper.cdc0426e.js";import"./QItem.1bce08e7.js";import"./QSelect.b17c746f.js";import"./QMenu.3c9cf304.js";import"./position-engine.53490cc8.js";import"./rtl.276c3f1b.js";import"./format.2cae61da.js";/* empty css                                                             */import"./axios.816e1a60.js";import"./header.10137493.js";import"./use-dialog-plugin-component.234e0905.js";import"./permissionApi.ffe0b82d.js";import"./CommonPopup.2b0ee10b.js";import"./authStore.fadf8446.js";import"./counsel-hub.145170b4.js";import"./ClosePopup.daa62b28.js";const be={class:"fit column"},Ie={class:"a-table a-border q-mb-xs full-width col-auto"},Ee={class:"a-border"},ke={class:"row"},_e={class:"row"},Ne={class:"a-border"},Re={class:"row"},qe={class:"row"},Ve={class:"row q-gutter-xs justify-end"},Me={class:"col column full-width a-border q-pa-xs"},Se={class:"row full-width justify-end q-pa-xs q-gutter-xs bg-grey-5 a-border"},xe={__name:"MenuManageTable",setup(Fe){const $=H.MENU_ACTION_TYPE.TAB,Q=H.MENU_ACTION_TYPE.NONE,K=de(),V=ge(),W=D(()=>V.hasPermission(j.MENU_ROLE.READ)),Y=D(()=>V.hasPermission(j.MENU_ROLE.SAVE));let N=!1;const h=p(!1),g=p(!1),w=p(""),y=p(null),J=[{label:"\uC804\uCCB4",value:null},{label:"\uC0AC\uC6A9",value:!0},{label:"\uC0AC\uC6A9 \uC548\uD568",value:!1}],k=p(null),d=p([]),v=p(!1),G=[{title:"#",field:"rownum",formatter:"rownum",headerHozAlign:"center",hozAlign:"center",headerSort:!1,resizable:!1,width:"50"},{title:"\uBA54\uB274\uBA85",field:"name",hozAlign:"left",headerHozAlign:"center",headerSort:!1,editor:"input",cellEdited:function(t){const e=t.getRow().getData();e._isModified=!0}},{title:"\uC21C\uC11C",field:"orderNumber",hozAlign:"center",headerHozAlign:"center",headerSort:!1,editor:"input",width:"50",cellEdited:function(t){const e=t.getRow().getData();e._isModified=!0}},{title:"\uBA54\uB274\uCF54\uB4DC",field:"code",hozAlign:"center",headerHozAlign:"center",headerSort:!1},{title:"\uC0C1\uC704\uCF54\uB4DC",field:"path",hozAlign:"center",headerHozAlign:"center",headerSort:!1,formatter:function(t,e,l){const n=t.getRow().getData();let i="";if(!n.parentEntityId)i="";else if(n.isNewPath)i=n.path||"";else if(n.path){const u=n.path.split(".");u.length>1?i=u.slice(0,-1).join("."):i=n.path}const o=document.createElement("div"),r=document.createElement("span");r.innerText=i;const a=document.createElement("button");a.innerText="\uC120\uD0DD",a.addEventListener("click",async function(u){if(u.stopPropagation(),!N){N=!0;try{const _=await Z(n);if(_){const{parentEntityId:b,newPath:O}=_;O&&(X(n,b),n.isNewPath=!0,n.path=O,n.parentEntityId=b,n._isModified=!0,d.value=[...d.value],k.value.replaceData(d.value),t.getTable().redraw(!0))}}finally{N=!1}}});const c=document.createElement("span");return c.innerText=" ",o.appendChild(r),o.appendChild(c),o.appendChild(a),o}},{title:"\uC0AC\uC6A9\uC5EC\uBD80",field:"usable",hozAlign:"center",headerHozAlign:"center",headerSort:!1,width:"150",editor:"list",editorParams:{values:{true:"\uC0AC\uC6A9",false:"\uC0AC\uC6A9 \uC548\uD568"}},formatter:function(t){const e=t.getValue();return e===!0||e==="true"?"\uC0AC\uC6A9":"\uC0AC\uC6A9 \uC548\uD568"},cellEdited:function(t){let e=t.getValue();if(e==="true"||e==="\uC0AC\uC6A9"?e=!0:(e==="false"||e==="\uC0AC\uC6A9 \uC548\uD568")&&(e=!1),typeof e=="boolean")t.getRow().update({usable:e});else{const n=t.getOldValue();t.setValue(n)}t.getRow().reformat();const l=t.getRow().getData();l._isModified=!0}},{title:"\uC561\uC158\uD0C0\uC785",field:"actionType",hozAlign:"center",headerHozAlign:"center",headerSort:!1,width:"150",editor:"list",editorParams:{values:{NONE:"\uC5C6\uC74C",TAB:"\uD0ED"}},formatter:function(t){const e=t.getValue();return e===null||e===""||e==Q?"\uC5C6\uC74C":e===$?"\uD0ED":e},cellEdited:function(t){let e=t.getValue();e===""&&(e=null),t.setValue(e),t.getRow().reformat();const l=t.getRow().getData();l._isModified=!0}},{title:"\uBA54\uB274 \uC544\uC774\uCF58",field:"iconSrc",hozAlign:"center",headerHozAlign:"center",headerSort:!1,width:"150",formatter:function(t,e,l){const n=t.getRow().getData(),i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.width="100%",i.title="\uAC00\uB85C\uC640 \uC138\uB85C\uC758 \uD574\uC0C1\uB3C4\uAC00 \uBE44\uC2B7\uD55C \uD06C\uAE30\uC758 \uC774\uBBF8\uC9C0\uC5EC\uC57C \uD569\uB2C8\uB2E4.";const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center";const r=document.createElement("img");r.style.width="30px",r.style.height="30px",r.style.marginRight="5px",o.appendChild(r);const a=n.iconSrc||(n.iconImageFile?n.iconImageFile.downloadUrl:null);n.iconSrc?r.src=n.iconSrc:n.iconImageFile&&n.iconImageFile.downloadUrl&&I.getImageWithToken(n.iconImageFile.downloadUrl).then(u=>{r.src=u}).catch(u=>{E(u)}),i.appendChild(o);const c=document.createElement("button");return c.innerText=a?"\uC0AD\uC81C":"\uB4F1\uB85D",c.addEventListener("click",async function(u){if(u.stopPropagation(),a){if(await L("\uC774\uBBF8\uC9C0\uB97C \uC0AD\uC81C \uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?"))try{await I.deleteMenuImage("REMOVE_ICON_BASE",n.entityId),n.iconSrc=null,n.iconImageFile=null,t.getRow().update(n),t.getTable().redraw(!0)}catch(b){E(b)}}else F(n,"iconFile",t)}),i.appendChild(c),i},cellEdited:function(t){const e=t.getRow().getData();e._isModified=!0}},{title:"\uD035\uBA54\uB274 \uC0AC\uC6A9\uC5EC\uBD80",field:"quickUsable",hozAlign:"center",headerHozAlign:"center",headerSort:!1,width:"150",editor:"list",editorParams:{values:{true:"\uC0AC\uC6A9",false:"\uC0AC\uC6A9 \uC548\uD568"}},formatter:function(t){if(t.getRow().getData().parentEntityId){const e=t.getValue();return e===!0||e==="true"?"\uC0AC\uC6A9":"\uC0AC\uC6A9 \uC548\uD568"}else return null},editable:function(t){return!!t.getRow().getData().parentEntityId},cellEdited:function(t){let e=t.getValue();if(e==="true"||e==="\uC0AC\uC6A9"?e=!0:(e==="false"||e==="\uC0AC\uC6A9 \uC548\uD568")&&(e=!1),typeof e=="boolean")t.getRow().update({quickUsable:e});else{const n=t.getOldValue();t.setValue(n)}t.getRow().reformat();const l=t.getRow().getData();l._isModified=!0}},{title:"\uD035\uBA54\uB274 \uC21C\uC11C",field:"quickOrderNumber",hozAlign:"center",headerHozAlign:"center",headerSort:!1,editor:"input",width:"100",formatter:function(t){return t.getRow().getData().parentEntityId?t.getValue():null},editable:function(t){return!!t.getRow().getData().parentEntityId},cellEdited:function(t){const e=t.getRow().getData();e._isModified=!0}},{title:"\uD035\uBA54\uB274 \uC544\uC774\uCF58",field:"quickIconSrc",hozAlign:"center",headerHozAlign:"center",headerSort:!1,width:"150",formatter:function(t,e,l){if(t.getRow().getData().parentEntityId){const n=t.getRow().getData(),i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.width="100%",i.title="\uAC00\uB85C\uC640 \uC138\uB85C\uC758 \uD574\uC0C1\uB3C4\uAC00 \uBE44\uC2B7\uD55C \uD06C\uAE30\uC758 \uC774\uBBF8\uC9C0\uC5EC\uC57C \uD569\uB2C8\uB2E4.";const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center";const r=document.createElement("img");r.style.width="30px",r.style.height="30px",r.style.marginRight="5px",o.appendChild(r);const a=n.quickIconSrc||(n.quickIconImageFile?n.quickIconImageFile.downloadUrl:null);n.quickIconSrc?r.src=n.quickIconSrc:n.quickIconImageFile&&n.quickIconImageFile.downloadUrl&&I.getImageWithToken(n.quickIconImageFile.downloadUrl).then(u=>{r.src=u}).catch(u=>{E(u)}),i.appendChild(o);const c=document.createElement("button");return c.innerText=a?"\uC0AD\uC81C":"\uB4F1\uB85D",c.addEventListener("click",async function(u){if(u.stopPropagation(),a){if(await L("\uC774\uBBF8\uC9C0\uB97C \uC0AD\uC81C \uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?"))try{await I.deleteMenuImage("REMOVE_ICON_QUICK",n.entityId),n.quickIconSrc=null,n.quickIconImageFile=null,t.getRow().update(n),t.getTable().redraw(!0)}catch(b){E(b)}}else F(n,"quickIconFile",t)}),i.appendChild(c),i}else return null}}];function Z(t){return new Promise(e=>{K.dialog({component:he,componentProps:{menuList:d.value}}).onOk(l=>{const{parentEntityId:n,path:i}=l.payload;if(t){if(t.entityId===n){f("\uC790\uAE30 \uC790\uC2E0\uC744 \uC0C1\uC704 \uCF54\uB4DC\uB85C \uC120\uD0DD\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."),e(null);return}if(M(t.children||[],n)){f("\uC790\uC2E0\uC758 \uD558\uC704 \uCF54\uB4DC\uB97C \uC0C1\uC704 \uCF54\uB4DC\uB85C \uC120\uD0DD\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."),e(null);return}e({parentEntityId:n,newPath:i})}else e(null)}).onCancel(()=>{e(null)}).onDismiss(()=>{e(null)})})}function M(t,e){for(const l of t){if(l.entityId===e)return!0;if(l.children&&l.children.length>0&&M(l.children,e))return!0}return!1}function X(t,e){S(t,d.value),x(t,e,d.value)}function S(t,e){for(let l=0;l<e.length;l++){const n=e[l];if(n.entityId===t.entityId)return e.splice(l,1),!0;if(n.children&&n.children.length>0&&S(t,n.children))return!0}return!1}function x(t,e,l){if(!e)return l.push(t),!0;for(const n of l){if(n.entityId===e)return n.children||(n.children=[]),n.children.push(t),!0;if(n.children&&n.children.length>0&&x(t,e,n.children))return!0}return!1}function F(t,e,l){const n=document.createElement("input");n.type="file",n.accept="image/*",n.style.display="none",n.addEventListener("change",function(){const i=n.files[0];if(i){if(!["image/jpeg","image/png","image/gif","image/webp","image/svg+xml","image/bmp","image/x-icon","image/tiff","image/avif"].includes(i.type)){f("\uC774\uBBF8\uC9C0 \uD30C\uC77C\uB9CC \uC5C5\uB85C\uB4DC \uAC00\uB2A5\uD569\uB2C8\uB2E4."),n.value="";return}const r=e==="iconFile"?"iconFile":"quickIconFile";t[r]=i,t._isModified=!0;const a=new FileReader;a.onload=function(c){const u=c.target.result;e==="iconFile"?t.iconSrc=u:e==="quickIconFile"&&(t.quickIconSrc=u),l.getRow().update(t),l.getTable().redraw(!0)},a.readAsDataURL(i)}}),document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function R(){if(W.value)try{const t=await I.getMenus();if(t.status===200){const e=n=>n.map(i=>{const{children:o,...r}=i,a={...r};return o&&o.length>0&&(a.children=e(o)),a}).sort((i,o)=>i.orderNumber-o.orderNumber),l=e(t.data);d.value=l,T()}}catch(t){E(t)}else f("\uBA54\uB274 \uC870\uD68C \uAD8C\uD55C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.")}function ee(){const t=k.value.getData(),e=[];if(!te(t)||!ie(t)||!ne(t))return;function l(i){i.forEach(o=>{o._isModified&&e.push(o),o.children&&o.children.length>0&&l(o.children)})}if(l(t),e.length===0){f("\uC218\uC815\uB41C \uBA54\uB274\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.");return}const n=e.map(i=>{const o=i.entityId;if(!o)return Promise.resolve();const r=new FormData;return r.append("entity.code",i.code),r.append("entity.name",i.name),r.append("entity.orderNumber",i.orderNumber),r.append("entity.actionType",i.actionType||"NONE"),r.append("entity.quickUsable",i.quickUsable||!1),r.append("entity.usable",i.usable||!1),i.quickOrderNumber&&r.append("entity.quickOrderNumber",i.quickOrderNumber),i.iconFile&&r.append("iconFile",i.iconFile),i.quickIconFile&&r.append("quickIconFile",i.quickIconFile),i.parentEntityId&&r.append("entity.parent.entityId",i.parentEntityId),I.putMenu(r,o).then(()=>{i._isModified=!1}).catch(a=>{f(`\uBA54\uB274 '${i.name}' \uC5C5\uB370\uC774\uD2B8 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.`)})});Promise.all(n).then(()=>{f("\uBA54\uB274\uAC00 \uC131\uACF5\uC801\uC73C\uB85C \uC800\uC7A5\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),R()}).catch(i=>{E(i)})}function te(t){let e=!0;const l=[];function n(i,o){const r={};for(const a of i)r[a.orderNumber]?(l.push(`'${o||"\uCD5C\uC0C1\uC704 \uB178\uB4DC"}'\uC5D0\uC11C \uC21C\uC11C \uBC88\uD638 '${a.orderNumber}'\uAC00 \uC911\uBCF5\uB429\uB2C8\uB2E4.`),e=!1):r[a.orderNumber]=!0,a.children&&a.children.length>0&&n(a.children,a.name)}return n(t,null),e||f(l.join(`
`)),e}function ne(t){let e=!0;const l=[];let n=!1;function i(o){o.forEach(r=>{(r.quickUsable===!0||r.quickUsable==="true")&&(n||(l.push("\uD035\uBA54\uB274 \uC0AC\uC6A9\uC5EC\uBD80\uAC00 '\uC0AC\uC6A9'\uC778 \uACBD\uC6B0,"),n=!0),!r.quickOrderNumber&&r.quickOrderNumber!==0&&(l.push(`'${r.name}'\uC758 \uD035\uBA54\uB274 \uC21C\uC11C\uB97C \uC785\uB825\uD574\uC57C \uD569\uB2C8\uB2E4.`),e=!1)),r.children&&r.children.length>0&&i(r.children)})}return i(t),e||f(l.join(`
`)),e}function ie(t){let e=!0;const l=[],n={};function i(o){o.forEach(r=>{if(r.quickUsable===!0||r.quickUsable==="true"){const a=r.quickOrderNumber;if(a==null||a==="")return;n[a]?(l.push(`\uD035\uBA54\uB274 \uC21C\uC11C \uBC88\uD638 '${a}'\uAC00 \uC911\uBCF5\uB429\uB2C8\uB2E4.`),e=!1):n[a]=r.name}r.children&&r.children.length>0&&i(r.children)})}return i(t),e||f(l.join(`
`)),e}async function A(){v.value=!0,await R(),T(),ce(()=>{v.value=!1})}function T(){let t=JSON.parse(JSON.stringify(d.value));h.value&&w.value.trim()&&(t=U(t,w.value.trim(),"name")),g.value&&y.value!==null&&(t=C(t,y.value)),d.value=t,k.value.replaceData(t)}function U(t,e,l){return t.reduce((n,i)=>{const o={...i};let r=!1;if(o[l]&&o[l].toString().toLowerCase().includes(e.toLowerCase())&&(r=!0),o.children&&o.children.length>0){const a=U(o.children,e,l);a.length>0?(r=!0,o.children=a):r?o.children=i.children:delete o.children}return r&&n.push(o),n},[])}function C(t,e){return t.reduce((l,n)=>{const i={...n};let o=i.usable===e;if(i.children&&i.children.length>0){const r=C(i.children,e);r.length>0?(o=!0,i.children=r):o?i.children=n.children:delete i.children}return o&&l.push(i),l},[])}async function re(){h.value=!1,g.value=!1,w.value="",y.value=null}return P(w,t=>{t?h.value=!0:h.value=!1}),P(y,t=>{t?g.value=!0:g.value=!1}),le(async()=>{v.value=!0,await R(),v.value=!1}),(t,e)=>(z(),oe("div",be,[s("table",Ie,[e[7]||(e[7]=s("colgroup",null,[s("col",{class:"t-column",width:"100px"}),s("col",{width:"600px"}),s("col",{class:"t-column",width:"100px"}),s("col",{width:"200px"})],-1)),s("tbody",null,[s("tr",null,[s("td",Ee,[s("div",ke,[m(B,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=l=>h.value=l)},null,8,["modelValue"]),e[5]||(e[5]=s("span",{class:"q-ml-xs"},"\uBA54\uB274\uBA85",-1))])]),s("td",null,[s("div",_e,[m(fe,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=l=>w.value=l),onKeyup:ae(A,["enter"])},null,8,["modelValue"])])]),s("td",Ne,[s("div",Re,[m(B,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=l=>g.value=l)},null,8,["modelValue"]),e[6]||(e[6]=s("span",{class:"q-ml-xs"},"\uC0AC\uC6A9\uC5EC\uBD80",-1))])]),s("td",null,[s("div",qe,[m(me,{class:"select-width",modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=l=>y.value=l),options:J},null,8,["modelValue"])])]),s("td",null,[s("div",Ve,[m(q,{label:"\uC870\uD68C",onClick:A}),m(q,{label:"\uCD08\uAE30\uD654",onClick:re})])])])])]),s("div",Me,[m(we,{title:"\uBA54\uB274 \uBAA9\uB85D",class:"col-auto full-width q-mb-xs"}),m(pe,{ref_key:"gridRef",ref:k,rows:d.value,columns:G,reactiveData:!1,class:"col full-width",dataTree:!0,dataTreeStartExpanded:!0,dataTreeElementColumn:"name",selectableRows:1},null,8,["rows"]),s("div",Se,[Y.value?(z(),se(q,{key:0,label:"\uC800\uC7A5",onClick:ee})):ue("",!0)])]),m(ye,{modelValue:v.value,"onUpdate:modelValue":e[4]||(e[4]=l=>v.value=l)},null,8,["modelValue"])]))}},dt=ve(xe,[["__scopeId","data-v-a5c70fa2"]]);export{dt as default};
