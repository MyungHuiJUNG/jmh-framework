var Q=Object.defineProperty;var q=(o,e,n)=>e in o?Q(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n;var d=(o,e,n)=>(q(o,typeof e!="symbol"?e+"":e,n),n);import{b as z}from"./index.02f7c95d.js";window.CounselFlowHubCode={ChannelState:{NOTLOGIN:"NOTLOGIN",READY:"READY",ABSENCE:"ABSENCE",PROCESS:"PROCESS"}};class Z{constructor(){this.channels=new Map,this.eventCallbacks=[]}addChannel(e,n){this.channels.set(e,n),n.addEventCallback(function(t){this.eventCallbacks.forEach(function(l){l(t)})}.bind(this))}getChannel(e){const n=this.channels.get(e);if(n==null)throw new Error("[flow-hub] can't find channel : "+e);return n}addEventCallback(e){e!=null&&this.eventCallbacks.unshift(e)}removeEventCallback(e){if(e!=null){let n=this.eventCallbacks.indexOf(e);n>=0&&this.eventCallbacks.splice(n,1)}}connect(e){const n=[];return e==null||e.length===0?this.channels.forEach(function(t){t.connected!==!0&&n.push(t.connect())}):e.forEach(function(t){const l=this.getChannel(t);l.connected!==!0&&n.push(l.connect())}.bind(this)),Promise.all(n)}disconnect(e){const n=[];return e==null||e.length===0?this.channels.forEach(function(t){t.connected!==!1&&n.push(t.disconnect())}):e.forEach(function(t){const l=this.getChannel(t);l.connected!==!1&&n.push(l.disconnect())}.bind(this)),Promise.all(n)}requestChannelState(e){const n=[];return e==null||e.length===0?this.channels.forEach(function(t){t.connected!==!1&&n.push(t.requestChannelState())}):e.forEach(function(t){const l=this.getChannel(t);l.connected!==!1&&n.push(l.requestChannelState())}.bind(this)),Promise.all(n)}login(e,n){const t=[];return e==null||e.length===0?this.channels.forEach(function(l){l.connected!==!1&&t.push(l.login(n))}):e.forEach(function(l){const s=this.getChannel(l);s.connected!==!1&&t.push(s.login(n))}.bind(this)),Promise.all(t)}logout(e,n){const t=[];return e==null||e.length===0?this.channels.forEach(function(l){l.connected!==!1&&t.push(l.logout(n))}):e.forEach(function(l){const s=this.getChannel(l);s.connected!==!1&&t.push(s.logout(n))}.bind(this)),Promise.all(t)}ready(e){const n=[];return e==null||e.length===0?this.channels.forEach(function(t){t.connected!==!1&&n.push(t.ready())}):e.forEach(function(t){const l=this.getChannel(t);l.connected!==!1&&n.push(l.ready())}.bind(this)),Promise.all(n)}absence(e,n){const t=[];return e==null||e.length===0?this.channels.forEach(function(l){l.connected!==!1&&t.push(l.absence(n))}):e.forEach(function(l){const s=this.getChannel(l);s.connected!==!1&&t.push(s.absence(n))}.bind(this)),Promise.all(t)}process(e){}}window.CounselFlowHubVoiceType=Object.freeze({ETS_FINESSE:"ETS_FINESSE",ETS_FINESSE_V2:"ETS_FINESSE_V2",IPRON_V5:"IPRON_V5"});window.CounselFlowHubVoiceCode=Object.freeze(Object.assign({},CounselFlowHubCode,{ChannelState:{NOTLOGIN:"NOTLOGIN",READY:"READY",ABSENCE:"ABSENCE",PROCESS:"PROCESS",RINGBACK:"RINGBACK",OFFERING:"OFFERING",BUSY:"BUSY",ACTIVE:"ACTIVE",HELD:"HELD"},CallType:{NORMAL:"NORMAL",CONSULT:"CONSULT",TRANSFER:"TRANSFER",CONFERENCE:"CONFERENCE",IVR:"IVR",AOD:"AOD"},DialType:{EXTERNAL:"EXTERNAL",INTERNAL:"INTERNAL"},ReasonType:{ABSENCE:"ABSENCE",REJECTCALL:"REJECTCALL",LOGOUT:"LOGOUT"},Direction:{INBOUND:"IB",OUTBOUND:"OB"}}));class i{constructor(e,n,t,l){this.channelType=e,this.channelInfo=n,this.expiredDate=t,this.queueReportInfo=l}}class _{constructor(){this.id=null,this.password=null,this.extension=null,this.state=CounselFlowHubCode.ChannelState.NOTLOGIN,this.subState=null}}class G{constructor(e){this.options=null,this.channelType=e,this.channelInfo=new _,this.eventCallbacks=[],this.connected=!1,this.absenceReasonCodes=[],this.queueReportInfo=[]}addEventCallback(e){e!=null&&this.eventCallbacks.unshift(e)}removeEventCallback(e){if(e!=null){let n=this.eventCallbacks.indexOf(e);n>=0&&this.eventCallbacks.splice(n,1)}}occurEvent(e){this.eventCallbacks.forEach(function(n){n(e)})}connect(){}disconnect(){}requestChannelState(){}requestReasons(e){}login(e){}logout(e){}ready(){}absence(e){}process(){}getFetcher(){}}class ee extends _{constructor(){super(),this.state=CounselFlowHubVoiceCode.ChannelState.NOTLOGIN,this.subState=null,this.callInfo=null,this.callInfos=[]}}class B extends G{constructor(e){super(e),this.channelInfo=new ee}dial(e){}acceptCall(){}rejectCall(e){}hold(){}retrieve(){}consult(e,n,t){}transfer(e){}conference(e){}hangup(){}setExtraData(e){}}class A{static _isPrintLog(){return this.isPrintLog!==void 0?this.isPrintLog:super.isPrintLog}static _isPrintInfo(){return this.isPrintInfo!==void 0?this.isPrintInfo:super.isPrintLog}static _isPrintDebug(){return this.isPrintDebug!==void 0?this.isPrintDebug:super.isPrintDebug}static _isPrintTrace(){return this.isPrintTrace!==void 0?this.isPrintTrace:super.isPrintTrace}static _isPrintWarn(){return this.isPrintWarn!==void 0?this.isPrintWarn:super.isPrintWarn}static _isPrintError(){return this.isPrintError!==void 0?this.isPrintError:super.isPrintError}static log(){this._isPrintLog()===!0&&console.log.apply(console,arguments)}static info(){this._isPrintInfo()===!0&&console.info.apply(console,arguments)}static debug(){this._isPrintDebug()===!0&&console.debug.apply(console,arguments)}static trace(){this._isPrintTrace()===!0&&console.trace.apply(console,arguments)}static warn(){this._isPrintWarn()===!0&&console.warn.apply(console,arguments)}static error(){this._isPrintError()===!0&&console.error.apply(console,arguments)}}d(A,"isPrintLog",!0),d(A,"isPrintInfo",!0),d(A,"isPrintDebug",!1),d(A,"isPrintTrace",!1),d(A,"isPrintWarn",!0),d(A,"isPrintError",!0);class x extends A{}class m extends x{}const p=class{constructor(e,n){this.channelType=e,this.code=n.code,this.message=n.message,n.original!==void 0&&(this.original=n.original)}static make(e){return Object.assign(e,{create:function(n){if(n===void 0)throw new Error("channelType is invalid.");return new p(n,this)}})}};let r=p;d(r,"LOGIN_FAIL",p.make({code:"1001",message:"login fail"})),d(r,"LOGIN_ALREADY_LOGINED",p.make({code:"1002",message:"already logined"})),d(r,"LOGIN_ALREADY_INPROGRESS",p.make({code:"1003",message:"already inprogress login"})),d(r,"LOGIN_WRONG_ID",p.make({code:"1004",message:"wrong id"})),d(r,"LOGIN_WRONG_PASSWORD",p.make({code:"1005",message:"wrong password"})),d(r,"LOGIN_USING_EXTENSION",p.make({code:"1006",message:"already using extension with another agent id"})),d(r,"LOGIN_WRONG_TENANT",p.make({code:"1004",message:"wrong tenant"})),d(r,"CHANNEL_NOT_LOGINED",p.make({code:"2001",message:"channel not logined"})),d(r,"INVALID_CHANNEL_STATE",p.make({code:"2002",message:"invalid channel state"})),d(r,"INVALID_EXTENSION_NUMBER",p.make({code:"2003",message:"invalid extension number"})),d(r,"INVALID_DST_STATE",p.make({code:"2004",message:"invalid destinated state"})),d(r,"INVALID_DST_NUMBER",p.make({code:"2005",message:"invalid destinated number"})),d(r,"INVALID_AGENT_SERVICE",p.make({code:"2006",message:"invalid agent service"})),d(r,"INVALID_PARAMETER",p.make({code:"2007",message:"invalid parameter"})),d(r,"INVALID_CALL_STATE",p.make({code:"3001",message:"invalid call state"})),d(r,"CMD_ALREADY_PROCESSING",p.make({code:"4001",message:"another command is processing"})),d(r,"NO_RESOURCE_FOR_OPERATION",p.make({code:"5001",message:"no resource for operation"})),d(r,"NO_CALL_FOR_TRANSFER",p.make({code:"5002",message:"no call for transfer"})),d(r,"SERVER_CONNECT_ERROR",p.make({code:"9997",message:"server connect error"})),d(r,"TIMEOUT",p.make({code:"9998",message:"operaton timeout"})),d(r,"UNKNOWN_ERROR",p.make({code:"9999",message:"unknown error"}));const D=class{static getInstance(){return this.instance===null&&(this.instance=new D),this.instance}constructor(){require("../externals/ETSClient_Base"),require("../externals/ETSClient_EMC"),require("../externals/ETSClient_Finesse"),require("../externals/ETSClient_Jtapi"),this.isChanged=!1,this.finesseHandler=null,this.emcHandlers=[],this.etsClient=null,this.etsClientConnectState=D.ConnectState.DISCONNECTED}setFinesseHandler(e){e!=null&&(this.isChanged=!0,this.finesseHandler=e)}addEmcHandler(e){e!=null&&(this.isChanged=!0,this.emcHandlers.push(e))}connect(){this.etsClientConnectState!==D.ConnectState.CONNECTING&&(this.etsClientConnectState=D.ConnectState.CONNECTING,this.getEtsClient().connectToServer())}disconnect(){this.etsClientConnectState!==D.ConnectState.DISCONNECTING&&(this.etsClientConnectState=D.ConnectState.DISCONNECTING,this.getEtsClient().disconnect())}getEtsClient(){if(this.isChanged===!1&&this.etsClient!==null)return this.etsClient;let e="";return this.finesseHandler!==null&&(e="finesse"),this.isChanged=!1,this.etsClient=CreateETSMsgLib(e,this.emcHandlers.length>0),this.finesseHandler!==null&&(this.etsClient.SetOnResultEvent(this.finesseHandler.onResultEvent.bind(this.finesseHandler)),this.etsClient.SetOnAgentEvent(this.finesseHandler.onAgentEvent.bind(this.finesseHandler)),this.etsClient.SetOnCallEvent(this.finesseHandler.onCallEvent.bind(this.finesseHandler)),this.etsClient.SetOnErrorEvent(this.finesseHandler.onErrorEvent.bind(this.finesseHandler))),this.emcHandlers.length>0&&(this.etsClient.EMC_SetOnResultEvent(function(n){this.emcHandlers.forEach(function(t){t.onResultEvent(n)})}.bind(this)),this.etsClient.EMC_SetOnAgentEvent(function(n){this.emcHandlers.forEach(function(t){t.onAgentEvent(n)})}.bind(this)),this.etsClient.EMC_SetOnCallEvent(function(n){this.emcHandlers.forEach(function(t){t.onCallEvent(n)})}.bind(this)),this.etsClient.EMC_SetOnErrorEvent(function(n){this.emcHandlers.forEach(function(t){t.onErrorEvent(n)})}.bind(this))),this.etsClient.SetOnServerEvent(function(n){const t=u.parseData(n);t.ret==="0"||t.ret===0?this.etsClientConnectState=D.ConnectState.CONNECTED:(t.ret==="1005"||t.ret===1005)&&(this.etsClientConnectState=D.ConnectState.DISCONNECTED),this.finesseHandler!==null&&this.finesseHandler.onServerEvent(n),this.emcHandlers.forEach(function(l){l.onServerEvent(n)})}.bind(this)),this.etsClient}};let c=D;d(c,"ConnectState",Object.freeze({CONNECTED:"CONNECTED",CONNECTING:"CONNECTING",DISCONNECTED:"DISCONNECTED",DISCONNECTING:"DISCONNECTING"})),d(c,"instance",null);class u{constructor(e){this.channel=e,this.serverPromise={resolve:null,reject:null},this.commandPromise={resolve:null,reject:null}}newPromise(e){return new Promise(function(n,t){e==="server"?(this.serverPromise.resolve=n,this.serverPromise.reject=t):(this.commandPromise.resolve=n,this.commandPromise.reject=t)}.bind(this))}occurResolve(e,n){n==="server"?(this.serverPromise.resolve!==null&&this.serverPromise.resolve(e),this.serverPromise.resolve=null,this.serverPromise.reject=null):(this.commandPromise.resolve!==null&&this.commandPromise.resolve(e),this.commandPromise.resolve=null,this.commandPromise.reject=null)}occurReject(e,n){n==="server"?(this.serverPromise.reject!==null&&this.serverPromise.reject(e),this.serverPromise.resolve=null,this.serverPromise.reject=null):(this.commandPromise.reject!==null&&this.commandPromise.reject(e),this.commandPromise.resolve=null,this.commandPromise.reject=null)}onServerEvent(e){const n=u.parseData(e);if(console.log("[counsel-flow-hub/ets-emc] onServerEvent : ",n),n.ret==="0"||n.ret===0)this.channel.connected=!0,this.occurResolve(n.msg,"server");else if(n.ret==="1005"||n.ret===1005)this.channel.connected=!1,this.occurResolve(n.msg,"server");else{const t=c.getInstance().getEtsClient().retryCnt,l=c.getInstance().getEtsClient().SOCK_RETRY_CNT;t===l&&this.occurReject(u.convertError(n,this.channel.channelType),"server"),this.occurReject(r.TIMEOUT.create(this.channel.channelType))}}onResultEvent(e){}onAgentEvent(e){}onCallEvent(e){}onErrorEvent(e){}static parseData(e){return typeof e=="string"?JSON.parse(e):e}static convertError(e,n){if(e.ret==="-200")return r.LOGIN_FAIL.create(n);if(e.ret==="-1"&&e.cmd==="LOGIN")return r.LOGIN_FAIL.create(n);if(e.ret==="-1")return r.INVALID_CHANNEL_STATE.create(n);if(e.ret==="-203"||e.ret==="-1001"||e.ret==="-1002"||e.ret==="-1003")return r.LOGIN_ALREADY_LOGINED.create(n);if(e.ret==="-204"||e.ret==="-1000")return r.CHANNEL_NOT_LOGINED.create(n);if(e.ret==="-207"||e.ret==="-208"||e.ret==="-209")return r.INVALID_CHANNEL_STATE.create(n);if(e.ret==="-210")return r.LOGIN_USING_EXTENSION.create(n);if(e.ret==="-2000"||e.ret==="-2001")return r.INVALID_PARAMETER.create(n);if(e.ret==="-4000")return r.SERVER_CONNECT_ERROR.create(n);const t=r.UNKNOWN_ERROR;return t.original={code:e.ret,message:e.desc},new r(n,t)}}class v{constructor(){this.callType=null,this.callId=null,this.direction=null,this.callerId=null,this.calledId=null,this.extraData=null,this.connectionId=null,this.xferCallId=null,this.xferDirection=null,this.xferCallerId="",this.xferCalledId="",this.xferExtraData=null,this.xferConnectionId=null}}class w extends u{constructor(e){super(e)}onResultEvent(e){const n=u.parseData(e);if(m.log("[counsel-flow-hub/voice/ets] onResultEvent : ",e),n.ret==="0"||n.ret===0){if(n.msg&&n.msg.state&&(this.channel.channelInfo.subState=n.msg.state==="NOT_READY"?n.msg.reason_id:""),n.cmd==="DROP"){const t=w.parseCallType(n.msg.call_type);(t===CounselFlowHubVoiceCode.CallType.CONSULT||t===CounselFlowHubVoiceCode.CallType.CONFERENCE)&&w.spliceCallInfos(n,this.channel.channelInfo)===!0&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.HELD,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date)))}this.occurResolve(n.msg)}else this.occurReject(u.convertError(n,this.channel.channelType))}onAgentEvent(e){const n=u.parseData(e);m.log("[counsel-flow-hub/voice/ets] onAgentEvent : ",e),n.msg.state!=="RESERVED"&&(this.channel.channelInfo.state=w.parseChannelState(n.msg.state),this.channel.channelInfo.subState=n.msg.state==="NOT_READY"?n.msg.reason_id:"",this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date)))}onCallEvent(e){const n=u.parseData(e);if(m.log("[counsel-flow-hub/voice/ets] onCallEvent : ",e),n.msg.call_type!=="SUPERVISOR_MONITOR"&&n.cmd==="dialog"){const t=u.parseData(n.msg[this.channel.channelInfo.extension]);if(!t)return;if(t.state==="ALERTING"||t.state==="INITIATED"||t.state==="ACTIVE"||t.state==="HELD"){let l=!1;if(this.channel.channelInfo&&this.channel.channelInfo.callInfos&&this.channel.channelInfo.callInfos.length>0&&this.channel.channelInfo.callInfos.forEach(a=>{a.callId===n.msg.call_id&&(l=!0)}),l===!1&&this.channel.channelInfo.callInfos.push(w.parseCallInfo(n,this.channel.channelInfo)),this.channel.channelInfo.callInfo&&this.channel.channelInfo.callInfo.xferCallId&&(n.msg.call_type==="PREROUTE_ACD_IN"||n.msg.call_type==="OUT"||n.msg.call_type==="AGENT_INSIDE"||n.msg.call_type==="CONSULT_OFFERED"||n.msg.call_type==="SUPERVISOR_MONITOR"))return;const s=w.parseCallType(n.msg.call_type);if(s===CounselFlowHubVoiceCode.CallType.TRANSFER&&this.channel.channelInfo.callInfos.length>1){this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date));return}if(s===CounselFlowHubVoiceCode.CallType.CONFERENCE&&this.channel.channelInfo.callInfo&&this.channel.channelInfo.callInfos.length===1){this.channel.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.NORMAL,this.channel.channelInfo.callInfo.xferCallId=null,this.channel.channelInfo.callInfo.xferDirection=null,this.channel.channelInfo.callInfo.xferCallerId=null,this.channel.channelInfo.callInfo.xferCalledId=null,this.channel.channelInfo.callInfo.xferExtraData=null,this.channel.channelInfo.callInfo.extraData&&this.channel.channelInfo.callInfo.extraData.callVariable11&&(this.channel.channelInfo.callInfo.extraData.callVariable11=""),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date));return}this.channel.channelInfo.state=w.parseChannelState(t.state),this.channel.channelInfo.callInfo=w.parseCallInfo(n,this.channel.channelInfo),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))}else t.state!=="INITIATING"&&this.channel.channelInfo.state!==CounselFlowHubVoiceCode.ChannelState.ABSENCE&&this.channel.channelInfo.state!==CounselFlowHubVoiceCode.ChannelState.PROCESS&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ABSENCE,this.channel.channelInfo.callInfo=null,this.channel.channelInfo.callInfos=[],this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date)))}}static parseChannelState(e){return e==="NOT_READY"?CounselFlowHubVoiceCode.ChannelState.ABSENCE:e==="READY"?CounselFlowHubVoiceCode.ChannelState.READY:e==="ALERTING"?CounselFlowHubVoiceCode.ChannelState.OFFERING:e==="INITIATED"?CounselFlowHubVoiceCode.ChannelState.RINGBACK:e==="TALKING"||e==="ACTIVE"?CounselFlowHubVoiceCode.ChannelState.ACTIVE:e==="HELD"||e==="HOLD"?CounselFlowHubVoiceCode.ChannelState.HELD:e==="DROPPED"||e==="WORK"||e==="WORK_READY"?CounselFlowHubVoiceCode.ChannelState.PROCESS:CounselFlowHubVoiceCode.ChannelState.NOTLOGIN}static parseCallInfo(e,n){const t=w.parseCallType(e.msg.call_type);if(t===null)return null;let l=new v;l.callId=e.msg.call_id,l.callType=t,l.direction=n.extension!==e.msg.from?CounselFlowHubVoiceCode.Direction.INBOUND:CounselFlowHubVoiceCode.Direction.OUTBOUND,l.callerId=e.msg.from,l.calledId=e.msg.to,(t===CounselFlowHubVoiceCode.CallType.CONSULT||t===CounselFlowHubVoiceCode.CallType.CONFERENCE)&&n.callInfo&&(n.callInfo.callerId&&(l.callerId=n.callInfo.callerId),n.callInfo.calledId&&(l.calledId=n.callInfo.calledId),w.copyToXferCallInfoFromCallInfo(l,n.callInfo)),l.extraData={},e.msg.callVariable1&&(l.extraData.callVariable1=e.msg.callVariable1),e.msg.callVariable2&&(l.extraData.callVariable2=e.msg.callVariable2),e.msg.callVariable3&&(l.extraData.callVariable3=e.msg.callVariable3),e.msg.callVariable4&&(l.extraData.callVariable4=e.msg.callVariable4),e.msg.callVariable5&&(l.extraData.callVariable5=e.msg.callVariable5),e.msg.callVariable6&&(l.extraData.callVariable6=e.msg.callVariable6),e.msg.callVariable7&&(l.extraData.callVariable7=e.msg.callVariable7),e.msg.callVariable8&&(l.extraData.callVariable8=e.msg.callVariable8),e.msg.callVariable9&&(l.extraData.callVariable9=e.msg.callVariable9),e.msg.callVariable10&&(l.extraData.callVariable10=e.msg.callVariable10);const s=e.msg["user.conftype"];s&&(l.extraData.callVariable11=s);const a=e.msg["user.accnum"];a&&(l.extraData.callVariable12=a);const h=e.msg["user.dialogID"];h&&(l.extraData.callVariable13=h);const I=e.msg["user.agentID"];return I&&(l.extraData.callVariable14=I),l}static parseCallType(e){return e==="CONSULT"?CounselFlowHubVoiceCode.CallType.CONSULT:e==="CONFERENCE"?CounselFlowHubVoiceCode.CallType.CONFERENCE:e==="TRANSFER"?CounselFlowHubVoiceCode.CallType.TRANSFER:CounselFlowHubVoiceCode.CallType.NORMAL}static copyToXferCallInfoFromCallInfo(e,n){e.xferCallId=n.callId,e.xferDirection=n.direction,e.xferCallerId=n.callerId,e.xferCalledId=n.calledId,e.xferExtraData=n.extraData}static spliceCallInfos(e,n){let t=-1;if(n.callInfos.forEach(function(l,s){l.callId===e.msg.call_id&&(t=s)}.bind(this)),t>=0){const l=t===n.callInfos.length-1;if(n.callInfos.splice(t,1),n.callInfo=new v,n.callInfos.length>=1)return n.callInfo=n.callInfos[n.callInfos.length-1],l}return!1}}class O extends u{constructor(e){super(e)}onResultEvent(e){const n=u.parseData(e);m.log("[counsel-flow-hub/voice/ets] onResultEvent : ",n),n.ret==="0"||n.ret===0?(n.cmd==="NOT_READY"&&(this.channel.channelInfo.subState=n.msg.reason_id,this.channel.channelInfo.callInfo=null),n.cmd==="DROP"&&O.parseCallType(n.msg.call_type)===CounselFlowHubVoiceCode.CallType.CONSULT&&O.rollbackCallInfoFromXferCallInfo(this.channel.channelInfo.callInfo),this.occurResolve(n.msg)):this.occurReject(u.convertError(n,this.channel.channelType))}onAgentEvent(e){const n=u.parseData(e);m.log("[counsel-flow-hub/voice/ets] onAgentEvent : ",n),this.channel.channelInfo.callInfo&&this.channel.channelInfo.callInfo.callType===CounselFlowHubVoiceCode.CallType.CONFERENCE&&n.msg.state==="TALKING"?(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.channelInfo.callInfo.xferCallId&&(this.channel.channelInfo.callInfo.callId=this.channel.channelInfo.callInfo.xferCallId),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))):n.msg.state==="HOLD"?(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.HELD,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))):n.msg.state==="RETRIEVE"?(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))):n.msg.state==="WORK"?(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.PROCESS,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))):n.msg.state==="NOT_READY"&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ABSENCE,this.channel.channelInfo.subState=n.msg.reason_id,this.channel.channelInfo.callInfo=null,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date)))}onCallEvent(e){const n=u.parseData(e);if(m.log("[counsel-flow-hub/voice/ets] onCallEvent : ",n),n.cmd==="dialog"){const t=n.msg.call_type;if(this.channel.channelInfo.callInfo&&this.channel.channelInfo.callInfo.xferCallId&&t==="OUT"||t==="CONSULT_OFFERED")return;const l=u.parseData(n.msg[this.channel.channelInfo.extension]);if(!l||l.state==="INITIATING"||(t===CounselFlowHubVoiceCode.CallType.TRANSFER||t===CounselFlowHubVoiceCode.CallType.CONFERENCE)&&n.msg.state==="ACTIVE"&&this.channel.channelInfo.callInfo&&this.channel.channelInfo.callInfo.callType===CounselFlowHubVoiceCode.CallType.CONSULT&&this.channel.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.ACTIVE)return;this.channel.channelInfo.state=O.parseChannelState(l.state),this.channel.channelInfo.subState=n.msg.reason_id,t===CounselFlowHubVoiceCode.CallType.CONSULT&&l.state==="DROPPED"?O.rollbackCallInfoFromXferCallInfo(this.channel.channelInfo.callInfo):this.channel.channelInfo.callInfo=O.parseCallInfo(n,this.channel.channelInfo),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))}}static parseChannelState(e){return e==="NOT_READY"?CounselFlowHubVoiceCode.ChannelState.ABSENCE:e==="READY"?CounselFlowHubVoiceCode.ChannelState.READY:e==="ALERTING"?CounselFlowHubVoiceCode.ChannelState.OFFERING:e==="INITIATED"?CounselFlowHubVoiceCode.ChannelState.RINGBACK:e==="TALKING"||e==="ACTIVE"?CounselFlowHubVoiceCode.ChannelState.ACTIVE:e==="HELD"||e==="HOLD"?CounselFlowHubVoiceCode.ChannelState.HELD:e==="DROPPED"||e==="WORK"||e==="WORK_READY"||e==="WRAP_UP"?CounselFlowHubVoiceCode.ChannelState.PROCESS:CounselFlowHubVoiceCode.ChannelState.NOTLOGIN}static parseCallInfo(e,n){let t=new v;const l=O.parseCallType(e.msg.call_type);return l===null||(t.callId=e.msg.call_id,t.callType=l,t.direction=n.extension!==e.msg.from?CounselFlowHubVoiceCode.Direction.INBOUND:CounselFlowHubVoiceCode.Direction.OUTBOUND,t.callerId=e.msg.from,t.calledId=e.msg.to,t.extraData={},e.msg.callVariable1&&(t.extraData.callVariable1=e.msg.callVariable1),e.msg.callVariable2&&(t.extraData.callVariable2=e.msg.callVariable2),e.msg.callVariable3&&(t.extraData.callVariable3=e.msg.callVariable3),e.msg.callVariable4&&(t.extraData.callVariable4=e.msg.callVariable4),e.msg.callVariable5&&(t.extraData.callVariable5=e.msg.callVariable5),e.msg.callVariable6&&(t.extraData.callVariable6=e.msg.callVariable6),e.msg.callVariable7&&(t.extraData.callVariable7=e.msg.callVariable7),e.msg.callVariable8&&(t.extraData.callVariable8=e.msg.callVariable8),e.msg.callVariable9&&(t.extraData.callVariable9=e.msg.callVariable9),e.msg.callVariable10&&(t.extraData.callVariable10=e.msg.callVariable10),l===CounselFlowHubVoiceCode.CallType.CONSULT&&(n.callInfo&&n.callInfo.xferCallId?(t.callerId=n.callInfo.callerId,t.calledId=n.callInfo.calledId,t.xferCallId=n.callInfo.xferCallId,t.xferDirection=n.callInfo.direction,t.xferCallerId=n.callInfo.callerId,t.xferCalledId=n.callInfo.calledId,t.xferExtraData=n.callInfo.extraData):(n.callInfo&&n.callInfo.callerId&&(t.callerId=n.callInfo.callerId),n.callInfo&&n.callInfo.calledId&&(t.calledId=n.callInfo.calledId),n.callInfo&&O.copyToXferCallInfoFromCallInfo(t,n.callInfo)))),t}static parseCallType(e){return e==="CONSULT"?CounselFlowHubVoiceCode.CallType.CONSULT:e==="CONFERENCE"?CounselFlowHubVoiceCode.CallType.CONFERENCE:e==="TRANSFER"?CounselFlowHubVoiceCode.CallType.TRANSFER:CounselFlowHubVoiceCode.CallType.NORMAL}static copyToXferCallInfoFromCallInfo(e,n){e.xferCallId=n.callId,e.xferDirection=n.direction,e.xferCallerId=n.callerId,e.xferCalledId=n.calledId,e.xferExtraData=n.extraData}static rollbackCallInfoFromXferCallInfo(e){e.callId=e.xferCallId,e.direction=e.xferDirection,e.callerId=e.xferCallerId,e.calledId=e.xferCalledId,e.extraData=e.xferExtraData,e.xferCallId=null,e.xferDirection=null,e.xferCallerId=null,e.xferCalledId=null,e.xferExtraData=null}}class U extends B{constructor(e){super(e),e===CounselFlowHubVoiceType.ETS_FINESSE?this.etsEventHandler=new w(this):e===CounselFlowHubVoiceType.ETS_FINESSE_V2&&(this.etsEventHandler=new O(this)),this.etsEventHandler&&c.getInstance().setFinesseHandler(this.etsEventHandler)}connect(){if(m.log("[counsel-flow-hub/voice/ets] connect"),this.options===null)throw new Error("[counsel-flow-hub/voice/ets] you must set options");return c.getInstance().getEtsClient().setServerInfo(this.options.activeServer,this.options.activePort,this.options.standbyServer,this.options.standbyPort,this.options.enableSsl),c.getInstance().connect(),this.etsEventHandler.newPromise("server")}disconnect(){return m.log("[counsel-flow-hub/voice/ets] disconnect"),c.getInstance().disconnect(),this.etsEventHandler.newPromise("server")}requestChannelState(){return m.log("[counsel-flow-hub/voice/ets] requestAgentState"),c.getInstance().getEtsClient().getUserList(),this.etsEventHandler.newPromise().then(function(e){const n=e[this.channelInfo.extension];if(n!==void 0){const t=JSON.parse(n);this.channelInfo.state=w.parseChannelState(t.state)}}.bind(this))}login(e){if(m.log("[counsel-flow-hub/voice/ets] login : channelInfo=>",e),e==null)throw new Error("[counsel-flow-hub/voice/ets] invalid channelInfo");return this.channelInfo.id=e.id,this.channelInfo.password=e.password,this.channelInfo.extension=e.extension,c.getInstance().getEtsClient().login(e.id,e.password,e.extension),this.etsEventHandler.newPromise().then(function(n){this.channelInfo.state=w.parseChannelState(n.state),this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}.bind(this))}logout(e){return m.log("[counsel-flow-hub/voice/ets] logout : reasonCode=>",e),c.getInstance().getEtsClient().logout(),this.etsEventHandler.newPromise().then(function(){this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.NOTLOGIN,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}.bind(this))}ready(){return m.log("[counsel-flow-hub/voice/ets] ready"),c.getInstance().getEtsClient().ready(),this.etsEventHandler.newPromise().then(function(){this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.READY,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}.bind(this))}absence(e){return m.log("[counsel-flow-hub/voice/ets] absense : reasonCode=>",e),c.getInstance().getEtsClient().notReady(e),this.etsEventHandler.newPromise().then(function(){this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ABSENCE,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}.bind(this))}dial(e){return m.log("[counsel-flow-hub/voice/ets] dial : dial=>",e),c.getInstance().getEtsClient().makeCall(e.calledId,e.extraData),this.etsEventHandler.newPromise()}acceptCall(){m.log("[counsel-flow-hub/voice/ets] accept call");let e="";return this.channelInfo.callInfo!==null&&(e=this.channelInfo.callInfo.callId),c.getInstance().getEtsClient().answerCall(e),this.etsEventHandler.newPromise().then(function(){this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}.bind(this))}rejectCall(e){m.log("[counsel-flow-hub/voice/ets] reject call : reasonCode=>",e);let n="";return this.channelInfo.callInfo!==null&&(n=this.channelInfo.callInfo.callId),c.getInstance().getEtsClient().rejectCall(n),this.etsEventHandler.newPromise()}hold(){m.log("[counsel-flow-hub/voice/ets] hold");let e="";return this.channelInfo.callInfo!==null&&(e=this.channelInfo.callInfo.callId),c.getInstance().getEtsClient().hold(e),this.etsEventHandler.newPromise()}retrieve(){m.log("[counsel-flow-hub/voice/ets] retrieve");let e="";return this.channelInfo.callInfo!==null&&(e=this.channelInfo.callInfo.callId),c.getInstance().getEtsClient().unHold(e),this.etsEventHandler.newPromise().then(function(){this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}.bind(this))}hangup(){m.log("[counsel-flow-hub/voice/ets] hangup");let e="";return this.channelInfo.callInfo!==null&&(e=this.channelInfo.callInfo.callId),c.getInstance().getEtsClient().releaseCall(e),this.etsEventHandler.newPromise()}transfer(e){if(m.log("[counsel-flow-hub/voice/ets] transfer : dial=>",e),this.channelInfo.callInfo!==null&&this.channelInfo.callInfo.xferCallId!==null)return c.getInstance().getEtsClient().transferComplete(),this.etsEventHandler.newPromise();let n="";return this.channelInfo.callInfo!==null&&(n=this.channelInfo.callInfo.callId),e.extraData&&c.getInstance().getEtsClient().setCallData(e.extraData,n),c.getInstance().getEtsClient().ssTransfer(e.calledId,n),this.etsEventHandler.newPromise()}consult(e){m.log("[counsel-flow-hub/voice/ets] consult",e);let n="";return this.channelInfo.callInfo!==null&&(n=this.channelInfo.callInfo.callId),e.extraData&&c.getInstance().getEtsClient().setCallData(e.extraData,n),c.getInstance().getEtsClient().consultCall(e.calledId,n),this.etsEventHandler.newPromise()}conference(e){return m.log("[counsel-flow-hub/voice/ets] conference..."),this.channelInfo.callInfo!==null&&this.channelInfo.callInfo.xferCallId!==null?(c.getInstance().getEtsClient().conferenceComplete(),this.etsEventHandler.newPromise()):(this.channelInfo.callInfo!==null&&this.channelInfo.callInfo.callId,c.getInstance().getEtsClient().conferenceComplete(),this.etsEventHandler.newPromise())}setExtraData(e){c.getInstance().getEtsClient().setCallData(e.extraData,e.callId)}}class E extends m{}d(E,"isPrintResponse",!0),d(E,"isPrintEvent",!0),d(E,"isPrintFetcherResponse",!0),d(E,"isPrintSubscribeEvent",!0);class f{constructor(e){this.channel=e,this.serverPromise={resolve:null,reject:null},this.commandPromise={resolve:null,reject:null}}newPromise(e){return new Promise(function(n,t){e==="server"?(this.serverPromise.resolve=n,this.serverPromise.reject=t):(this.commandPromise.resolve=n,this.commandPromise.reject=t)}.bind(this))}occurResolve(e,n){n==="server"?(this.serverPromise.resolve!==null&&this.serverPromise.resolve(e),this.serverPromise.resolve=null,this.serverPromise.reject=null):(this.commandPromise.resolve!==null&&this.commandPromise.resolve(e),this.commandPromise.resolve=null,this.commandPromise.reject=null)}occurReject(e,n){n==="server"?(this.serverPromise.reject!==null&&this.serverPromise.reject(e),this.serverPromise.resolve=null,this.serverPromise.reject=null):(this.commandPromise.reject!==null&&this.commandPromise.reject(e),this.commandPromise.resolve=null,this.commandPromise.reject=null)}onResponse(e){let n=E.isPrintResponse;if(E.isPrintFetcherResponse===!1&&e.messagetype===ipron.MsgType.ICResponse&&(e.method===ipron.APIMethod.GETGROUPLIST_RES||e.method===ipron.APIMethod.GETQUEUELIST_RES||e.method===ipron.APIMethod.GETAGENT_QUEUELIST_RES)&&(n=!1),n===!0&&E.log("[counsel-flow-hub/voice/ipron] onResponse : ",e),e.messagetype===ipron.MsgType.AjaxResponse)e.method===ipron.Request.CloseServer&&e.result===ipron.JSONValue.True&&(this.channel.connected=!1,this.occurResolve(e,"server")),e.result===ipron.JSONValue.False&&this.occurReject(r.UNKNOWN_ERROR.create(this.channel.channelType));else if(e.messagetype===ipron.MsgType.ICResponse){if(e.method===ipron.APIMethod.GETGROUPLIST_RES){if(e.result===0){const t=[];f.getExtensionDataKeys(e.extensiondata).forEach(function(s){const a=e.extensiondata[s];t.push({id:s,name:a!=null&&a.length>0?a[0]:""})}),this.occurResolve(t);return}}else if(e.method===ipron.APIMethod.GETQUEUELIST_RES){if(e.result===0){const t=[];f.getExtensionDataKeys(e.extensiondata).forEach(function(s){const a=e.extensiondata[s];t.push({id:s,dn:a!=null&&a.length>0?a[0]:"",name:a!=null&&a.length>1?a[1]:""})}),this.occurResolve(t);return}}else if(e.method===ipron.APIMethod.GETAGENT_QUEUELIST_RES){if(e.result===0){const t=[];f.getExtensionDataKeys(e.extensiondata).forEach(function(s){const a=e.extensiondata[s];t.push({id:s,name:a!=null&&a.length>0?a[0]:"",dn:a!=null&&a.length>1?a[1]:"",skillId:a!=null&&a.length>2?a[2]:""})}),this.occurResolve(t);return}}else if(e.method===ipron.APIMethod.GETAGENTLIST_RES&&e.result===0){const t=[];f.getExtensionDataKeys(e.extensiondata).forEach(function(s){const a=e.extensiondata[s];let h="",I=a!=null&&a.length>4?Number(a[4]):"";a!=null&&a.length>3&&(h=f.parseChannelState(Number(a[3])),a[3]==="20"&&(h=CounselFlowHubVoiceCode.ChannelState.ABSENCE,I=-999)),t.push({assignDn:a!=null&&a.length>0?a[0]:"",loginDn:a!=null&&a.length>1?a[1]:"",agentName:a!=null&&a.length>2?a[2]:"",state:h,subState:I,stateTime:a!=null&&a.length>5?Number(a[5]):"",inOut:a!=null&&a.length>6?f.getInboundOutbound(Number(a[6])):"",skillLevel:a!=null&&a.length>7?a[7]:""})}),this.occurResolve(t);return}e.result===0?this.occurResolve(e):this.occurReject(f.convertError(e,this.channel.channelType))}}onEvent(e){let n=E.isPrintEvent;if(E.isPrintSubscribeEvent===!1&&e.method===ipron.APIEvent.QUEUE_SSCRIBE_PUSH&&(n=!1),n===!0&&E.log("[counsel-flow-hub/voice/ipron] onEvent : ",e),e.method===ipron.WebEvent.ERR_OPENSERVER||e.method===ipron.WebEvent.ERR_DISCONNECT||e.method===ipron.APIEvent.ACTIVE_TIMEOUT){let t=this.channel.connected===!0;this.channel.connected=!1,this.occurReject(f.convertError(e,this.channel.channelType),"server"),t===!0&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.NOTLOGIN,this.channel.channelInfo.subState=null,this.channel.isLogoutByUser===!1&&(this.channel.channelInfo.subState=-1e3),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e))))}else if(e.method===ipron.APIEvent.OPENSRVSUCCESS)this.channel.connected=!0,this.occurResolve(e,"server");else if(e.method===ipron.APIEvent.BANISHMENT)ipron.Unregister(this.channel.channelInfo.extension,this.channel.options.tenant),ipron.CloseServer(),this.channel.connected=!1,this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.NOTLOGIN,this.channel.channelInfo.subState=null,this.channel.channelInfo.callInfo=null,this.channel.channelInfo.callInfos=[],this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else if(e.method===ipron.APIEvent.QUEUE_SSCRIBE_PUSH&&this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e),f.parseQueueReportInfo(e))),e.agentstate!==void 0){const t=f.parseChannelState(e.agentstate),l=e.agentstatesub;(this.channel.channelInfo.state!==t||this.channel.channelInfo.subState!==l)&&(this.channel.channelInfo.state=t,this.channel.channelInfo.subState=l,this.channel.channelInfo.state!==CounselFlowHubVoiceCode.ChannelState.ACTIVE&&(this.channel.channelInfo.callInfo=new v,this.channel.channelInfo.callInfos=[]),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e))))}else if(e.method===ipron.APIEvent.INITIATED)this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.BUSY,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else if(e.method===ipron.APIEvent.RINGING)this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.OFFERING,this.channel.channelInfo.callInfo=f.parseCallInfo(e,this.channel.channelInfo),this.channel.channelInfo.callInfos.push(this.channel.channelInfo.callInfo),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else if(e.method===ipron.APIEvent.DIALING)this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.RINGBACK,this.channel.channelInfo.callInfo=f.parseCallInfo(e,this.channel.channelInfo),this.channel.channelInfo.callInfos.length>=2&&(this.channel.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.CONSULT),this.channel.channelInfo.callInfos.push(this.channel.channelInfo.callInfo),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else if(e.method===ipron.APIEvent.ESTABLISHED)this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else if(e.method===ipron.APIEvent.PARTYCHANGED){this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.TRANSFER,this.channel.channelInfo.callInfo.callId=e.callid,this.channel.channelInfo.callInfo.connectionId=e.connectionid;const t=f.parseCallInfo(e,this.channel.channelInfo);this.channel.channelInfo.callInfo.extraData=t.extraData,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)))}else if(e.method===ipron.APIEvent.PARTYADDED){const t=this.channel.channelInfo.callInfo.callType;this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.CONFERENCE,this.channel.channelInfo.callInfo.callId=e.callid,this.channel.channelInfo.callInfo.connectionId=e.connectionid,t===CounselFlowHubVoiceCode.CallType.NORMAL&&(this.channel.channelInfo.callInfo.xferCallId=e.callid,this.channel.channelInfo.callInfo.xferConnectionId=e.connectionid,this.channel.channelInfo.callInfo.xferDirection=CounselFlowHubVoiceCode.Direction.OUTBOUND,this.channel.channelInfo.callInfo.xferCallerId=e.otherdn,this.channel.channelInfo.callInfo.xferCalledId=e.thirdpartydn);const l=f.parseCallInfo(e,this.channel.channelInfo);this.channel.channelInfo.callInfo.extraData=l.extraData,this.channel.channelInfo.callInfos=[],this.channel.channelInfo.callInfos.push(this.channel.channelInfo.callInfo),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)))}else if(e.method===ipron.APIEvent.PARTYDELETED){this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.NORMAL,this.channel.channelInfo.callInfo.calledId=this.channel.channelInfo.callInfo.xferCalledId,this.channel.channelInfo.callInfo.callerId=this.channel.channelInfo.callInfo.xferCallerId,this.channel.channelInfo.callInfo.direction=this.channel.channelInfo.callInfo.xferDirection,this.channel.channelInfo.callInfo.xferCallId=null,this.channel.channelInfo.callInfo.xferConnectionId=null,this.channel.channelInfo.callInfo.xferDirection=null,this.channel.channelInfo.callInfo.xferCallerId=null,this.channel.channelInfo.callInfo.xferCalledId=null;const t=f.parseCallInfo(e,this.channel.channelInfo);this.channel.channelInfo.callInfo.extraData=t.extraData,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)))}else if(e.method===ipron.APIEvent.HELD)e.connectionid===this.channel.channelInfo.callInfo.connectionId&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.HELD,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e))));else if(e.method===ipron.APIEvent.RETRIEVED)e.connectionid===this.channel.channelInfo.callInfo.connectionId&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e))));else if(e.method===ipron.APIEvent.RELEASED){let t=-1;if(this.channel.channelInfo.callInfos.forEach(function(l,s){l.callId===e.callid&&(t=s)}.bind(this)),t>=0){const l=t===this.channel.channelInfo.callInfos.length-1;if(this.channel.channelInfo.callInfos.splice(t,1),this.channel.channelInfo.callInfo=new v,this.channel.channelInfo.callInfos.length>=1){if(this.channel.channelInfo.callInfo=this.channel.channelInfo.callInfos[this.channel.channelInfo.callInfos.length-1],l===!0)this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.HELD,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else if(this.channel.channelInfo.callInfos.length===1)if(this.channel.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.ACTIVE)this.channel.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.NORMAL,this.channel.channelInfo.callInfo.xferCallId=null,this.channel.channelInfo.callInfo.xferDirection=null,this.channel.channelInfo.callInfo.xferCallerId=null,this.channel.channelInfo.callInfo.xferCalledId=null,this.channel.channelInfo.callInfo.xferExtraData=null,this.channel.channelInfo.callInfo.xferConnectionId=null,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e)));else{this.channel.channelInfo.callInfo.xferCallId=null,this.channel.channelInfo.callInfo.xferDirection=null,this.channel.channelInfo.callInfo.xferCallerId=null,this.channel.channelInfo.callInfo.xferCalledId=null,this.channel.channelInfo.callInfo.xferExtraData=null,this.channel.channelInfo.callInfo.xferConnectionId=null;return}}}}else e.method===ipron.APIEvent.DIVERTED&&this.channel.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.OFFERING&&(this.channel.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ABSENCE,(this.channel.channelInfo.callInfo.extraData===void 0||this.channel.channelInfo.callInfo.extraData===null)&&(this.channel.channelInfo.callInfo.extraData={}),this.channel.channelInfo.callInfo.extraData.isDiverted=!0,this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,f.extractDate(e))))}static parseChannelState(e){return e===30?CounselFlowHubVoiceCode.ChannelState.ABSENCE:e===40||e===41||e===42?CounselFlowHubVoiceCode.ChannelState.READY:e===50?CounselFlowHubVoiceCode.ChannelState.ACTIVE:e===51?CounselFlowHubVoiceCode.ChannelState.OFFERING:e===52?CounselFlowHubVoiceCode.ChannelState.RINGBACK:e===60?CounselFlowHubVoiceCode.ChannelState.PROCESS:CounselFlowHubVoiceCode.ChannelState.NOTLOGIN}static parseCallInfo(e,n){const t=new v;t.callType=CounselFlowHubVoiceCode.CallType.NORMAL,t.callId=e.callid,t.connectionId=e.connectionid;let l=e.ani,s=e.otherdn;if(e.calltype===2?(t.direction=CounselFlowHubVoiceCode.Direction.INBOUND,e.ani!==void 0&&e.ani.length>0&&(s=e.ani)):e.calltype===3?(t.direction=CounselFlowHubVoiceCode.Direction.OUTBOUND,e.dnis!==void 0&&e.dnis.length>0&&(s=e.dnis)):e.lastdn!==void 0&&e.lastdn.length>0&&(l=e.lastdn,s=e.lastdn),t.direction===null&&(t.direction=n.extension===l?CounselFlowHubVoiceCode.Direction.OUTBOUND:CounselFlowHubVoiceCode.Direction.INBOUND),t.callerId=t.direction===CounselFlowHubVoiceCode.Direction.OUTBOUND?n.extension:s,t.calledId=t.direction===CounselFlowHubVoiceCode.Direction.OUTBOUND?s:n.extension,e.extensiondata!==void 0){if(e.extensiondata.xferData!==void 0&&e.extensiondata.xferData!==null){const a=JSON.parse(e.extensiondata.xferData);if(a.xferCallId!==null?f.copyToXferCallInfoFromXferCallInfo(t,a):f.copyToXferCallInfoFromCallInfo(t,a),t.xferCallId=a.callId,t.xferConnectionId=a.connectionId,e.extensiondata.xferData=void 0,t.callType=CounselFlowHubVoiceCode.CallType.CONSULT,e.extensiondata.direct!==void 0&&e.extensiondata.direct!==null){const h=JSON.parse(e.extensiondata.direct);h.type==="TRANSFER"?t.callType=CounselFlowHubVoiceCode.CallType.TRANSFER:h.type==="CONFERENCE"&&(t.callType=CounselFlowHubVoiceCode.CallType.CONFERENCE),e.extensiondata.direct=void 0}}t.extraData=e.extensiondata}return e.ucid!==void 0&&((t.extraData===void 0||t.extraData===null)&&(t.extraData={}),t.extraData.ucid=e.ucid),t}static parseQueueReportInfo(e){return{waitCount:e.waitcount,method:e.method}}static getExtensionDataKeys(e){return e==null?[]:Object.keys(e)}static getInboundOutbound(e){switch(e){case 1:return CounselFlowHubVoiceCode.Direction.INBOUND;case 2:return CounselFlowHubVoiceCode.Direction.OUTBOUND}return""}static copyToXferCallInfoFromCallInfo(e,n){e.xferCallId=n.callId,e.xferDirection=n.direction,e.xferCallerId=n.callerId,e.xferCalledId=n.calledId,e.xferExtraData=n.extraData,e.xferConnectionId=n.connectionId}static copyToXferCallInfoFromXferCallInfo(e,n){e.xferCallId=n.xferCallId,e.xferDirection=n.xferDirection,e.xferCallerId=n.xferCallerId,e.xferCalledId=n.xferCalledId,e.xferExtraData=n.xferExtraData,e.xferConnectionId=n.xferConnectionId}static extractConnectionInfos(e){const n=[];return Object.keys(e).forEach(function(l){const s=e[l];s.length>=3&&n.push({connectionId:l,callId:s[2]})}.bind(this)),n}static extractCallInfos(e){const n=[];return Object.keys(e).forEach(function(l){const s=e[l];s.length>=3&&n.push({state:s[1],dn:s[2]})}),n}static extractDate(e){function n(t){const l=t.substr(0,4),s=t.substr(4,2),a=t.substr(6,2),h=t.substr(8,2),I=t.substr(10,2),N=t.substr(12,2);return new Date(l,s-1,a,h,I,N)}return e.datetime!==void 0&&e.datetime!==null&&e.datetime.length>=14?n(e.datetime):new Date}static convertError(e,n){const t=r.UNKNOWN_ERROR;return t.original={method:e.method,result:e.result,code:e.status,message:e.statusText},e.statusText==="timeout"?r.TIMEOUT.create(n):e.result===2001?r.LOGIN_ALREADY_LOGINED.create(n):e.result===2103?r.LOGIN_WRONG_TENANT.create(n):e.result===2101?r.INVALID_EXTENSION_NUMBER.create(n):e.result===2105?r.LOGIN_WRONG_ID.create(n):e.result===2106||e.result===2107||e.result===2110||e.result===2111?r.NO_RESOURCE_FOR_OPERATION.create(n):e.result===2502?r.LOGIN_WRONG_PASSWORD.create(n):e.result===2402?r.INVALID_CHANNEL_STATE.create(n):e.result===2405||e.result===2506?r.INVALID_CALL_STATE.create(n):new r(n,t)}}class ne{constructor(e){this.channel=e}}class R extends m{}class te extends ne{constructor(e){super(e)}getGroupList(){return this.channel.pushCommand(e=>{R.log("[counsel-flow-hub/voice/ipron] get group list"),ipron.GetGroupList(this.channel.options.tenant,0),this.channel.applyEventHandlerPromise(e)})}getQueueList(){return this.channel.pushCommand(e=>{R.log("[counsel-flow-hub/voice/ipron] get queue list"),ipron.GetQueueList(this.channel.options.tenant,0),this.channel.applyEventHandlerPromise(e)})}getAgentQueueList(){return this.channel.pushCommand(e=>{R.log("[counsel-flow-hub/voice/ipron] get agent queue list"),ipron.GetAgentQueueList(this.channel.options.tenant,this.channel.channelInfo.id),this.channel.applyEventHandlerPromise(e)})}getAgentList(e,n){return this.channel.pushCommand(t=>{if(R.log("[counsel-flow-hub/voice/ipron] get agent list"),e==null)throw new Error("[counsel-flow-hub/voice/ipron] group id is empty");n==null&&(n=""),ipron.GetAgentList(this.channel.options.tenant,e,n,0,0,0),this.channel.applyEventHandlerPromise(t)})}reportTenant(){return this.channel.pushCommand(e=>{R.log("[counsel-flow-hub/voice/ipron] report tenant"),ipron.TenantReport(this.channel.options.tenant,0),this.channel.applyEventHandlerPromise(e)})}reportAgent(){return this.channel.pushCommand(e=>{R.log("[counsel-flow-hub/voice/ipron] report agent"),ipron.AgentReport(this.channel.channelInfo.id,this.channel.options.tenant,0),this.channel.applyEventHandlerPromise(e)})}reportGroup(e){return this.channel.pushCommand(n=>{if(R.log("[counsel-flow-hub/voice/ipron] report group=>",e),e==null||e.length===0)throw new Error("[counsel-flow-hub/voice/ipron] group id list is empty");let t="";e.forEach(function(l,s){t+=l,s<e.length-1&&(t+="-")}),ipron.GroupReport(this.channel.options.tenant,t,0),this.channel.applyEventHandlerPromise(n)})}reportQueue(e){return this.channel.pushCommand(n=>{if(R.log("[counsel-flow-hub/voice/ipron] report queue=>",e),e==null||e.length===0)throw new Error("[counsel-flow-hub/voice/ipron] queue dn list is empty");let t="";e.forEach(function(l,s){t+=l,s<e.length-1&&(t+="-")}),ipron.QueueReport(this.channel.options.tenant,t,0),this.channel.applyEventHandlerPromise(n)})}reportQueueSubscribe(e,n){return this.channel.pushCommand(t=>{R.log("[counsel-flow-hub/voice/ipron] report queue subscribe start"),ipron.QueueRptSubscribe(e,n,null,1,0),this.channel.applyEventHandlerPromise(t)})}}class S extends B{constructor(e){super(e),this.isLogoutByUser=!1,this.absenceReasonCodes=[],this.eventHandler=new f(this),this.fetcher=new te(this),this.commandQueue=[],this.checkQueueAndCommand()}connect(){if(E.log("[counsel-flow-hub/voice/ipron] connect"),this.options===null)throw new Error("[counsel-flow-hub/voice/ipron] you must set options");return ipron.SetProtocol(this.options.protocol),ipron.SetServerInfo(this.options.activeServer,this.options.activePort,this.options.standbyServer,this.options.standbyPort),ipron.OpenServer(this.options.appName,this.eventHandler.onEvent.bind(this.eventHandler),this.eventHandler.onResponse.bind(this.eventHandler)),this.eventHandler.newPromise("server")}disconnect(){return E.log("[counsel-flow-hub/voice/ipron] disconnect"),ipron.CloseServer(),this.eventHandler.newPromise("server")}requestChannelState(e){return this.pushCommand(n=>{E.log("[counsel-flow-hub/voice/ipron] requestAgentState"),e==null?ipron.GetAgentState(this.options.tenant,this.channelInfo.id,"",0,0):ipron.GetAgentState(this.options.tenant,e,"",0,0),this.applyEventHandlerPromise(n)}).then(n=>{const t={state:f.parseChannelState(n.voipagentstate),subState:null};return(n.voipagentstate==="20"||n.voipagentstate===20)&&(t.state=CounselFlowHubVoiceCode.ChannelState.ABSENCE,t.subState=-999),e==null&&(this.channelInfo.state=t.state,this.channelInfo.subState=t.subState),t})}login(e){return this.pushCommand(n=>{if(E.log("[counsel-flow-hub/voice/ipron] login : channelInfo=>",e),e==null)throw new Error("[counsel-flow-hub/voice/ipron] invalid channelInfo");this.channelInfo.id=e.id,this.channelInfo.password=e.password,this.channelInfo.extension=e.extension,ipron.Register(this.channelInfo.extension,this.options.tenant),this.applyEventHandlerPromise(n)}).then(()=>this.pushCommand(n=>{ipron.GetStateSubcode(this.options.tenant,30),this.applyEventHandlerPromise(n)})).then(n=>this.pushCommand(t=>{n.extensiondata!==void 0&&Object.keys(n.extensiondata).forEach(function(h){let I=n.extensiondata[h];I instanceof Array&&I.length>0&&(I=I[0]),this.absenceReasonCodes.push({name:I,value:h})}.bind(this));let l=20;this.options.stateAfterLogin!==null&&(l=30,this.options.stateAfterCall===CounselFlowHubVoiceCode.ChannelState.ABSENCE?l=30:this.options.stateAfterCall===CounselFlowHubVoiceCode.ChannelState.READY?l=40:this.options.stateAfterCall===CounselFlowHubVoiceCode.ChannelState.READY&&(l=60));let s="";this.options.stateSubAfterLogin!==null&&(s=this.options.stateSubAfterLogin),ipron.AgentLogin(this.channelInfo.extension,this.channelInfo.id,this.channelInfo.password,this.options.tenant,l,s,0,4,0),this.applyEventHandlerPromise(t)})).then(n=>{const t=f.parseChannelState(n.agentstate);t===CounselFlowHubVoiceCode.ChannelState.NOTLOGIN?(this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ABSENCE,this.channelInfo.subState=-999):t===CounselFlowHubVoiceCode.ChannelState.ACTIVE&&(this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.ACTIVE,this.channelInfo.callInfo=new v);let l=-1;if(this.options.stateAfterCall===CounselFlowHubVoiceCode.ChannelState.ABSENCE?l=30:this.options.stateAfterCall===CounselFlowHubVoiceCode.ChannelState.READY?l=40:this.options.stateAfterCall===CounselFlowHubVoiceCode.ChannelState.PROCESS&&(l=60),l!==-1)return this.pushCommand(s=>{ipron.SetAFTCallState(this.channelInfo.id,this.options.tenant,l,0),this.applyEventHandlerPromise(s)})}).then(()=>{if(this.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.ABSENCE&&this.channelInfo.subState===-999)this.occurEvent(new i(this.channelType,this.channelInfo,new Date));else if(this.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.ACTIVE)return this.pushCommand(n=>{ipron.GetConnectionEx(this.channelInfo.extension),this.applyEventHandlerPromise(n)})}).then(n=>{if(n!==void 0&&n.extensiondata!==void 0){const t=f.extractConnectionInfos(n.extensiondata);if(t.length>0){const l=t[t.length-1];this.channelInfo.callInfo.callType=CounselFlowHubVoiceCode.CallType.NORMAL,this.channelInfo.callInfo.callId=Number(l.callId),this.channelInfo.callInfo.connectionId=l.connectionId}}(this.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.ACTIVE||this.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.HELD||this.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.RINGBACK||this.channelInfo.state===CounselFlowHubVoiceCode.ChannelState.OFFERING)&&this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}logout(e){return this.pushCommand(n=>{E.log("[counsel-flow-hub/voice/ipron] logout : reasonCode=>",e),this.isLogoutByUser=!0,ipron.isAsyncWhenLogout=e!=="refresh",ipron.AgentLogout(this.channelInfo.extension,this.channelInfo.id,this.options.tenant,0),this.applyEventHandlerPromise(n)}).then(()=>{this.isLogoutByUser=!1,this.channelInfo.state=CounselFlowHubVoiceCode.ChannelState.NOTLOGIN,this.channelInfo.subState=null,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}).then(()=>this.pushCommand(n=>{ipron.Unregister(this.channelInfo.extension,this.options.tenant),this.applyEventHandlerPromise(n)}))}ready(){return this.pushCommand(e=>{E.log("[counsel-flow-hub/voice/ipron] ready"),ipron.SetAgentState(this.channelInfo.id,this.options.tenant,40,"",0,0),this.applyEventHandlerPromise(e)})}absence(e){return this.pushCommand(n=>{E.log("[counsel-flow-hub/voice/ipron] absense : reasonCode=>",e),ipron.SetAgentState(this.channelInfo.id,this.options.tenant,30,e,0,0),this.applyEventHandlerPromise(n)})}dial(e){return this.pushCommand(n=>{E.log("[counsel-flow-hub/voice/ipron] dial : dial=>",e);let t=0;e.extraData!==void 0&&e.extraData!==null&&(t=ipron.EXTCreateExtension(),S.addExtraData(t,e.extraData));const l=S.makeDialData(e);ipron.MakeCall(this.channelInfo.extension,e.calledId,l.obCallingDn,l.skillLevel,l.priority,l.relationAgentDn,l.relationAgentId,l.relationMethod,l.routeMethod,l.routeSkillId,l.routeGroupId,l.Ucid,t,0,l.usePrevAgent,l.useDesignatedAgent,l.relationTimeout),this.applyEventHandlerPromise(n)})}acceptCall(){return this.pushCommand(e=>{E.log("[counsel-flow-hub/voice/ipron] accept call");let n="";this.channelInfo.callInfo.connectionId!==null&&(n=this.channelInfo.callInfo.connectionId),ipron.AnswerCall(this.channelInfo.extension,n,0,0),this.applyEventHandlerPromise(e)})}rejectCall(e){return this.pushCommand(n=>{E.log("[counsel-flow-hub/voice/ipron] reject call : reasonCode=>",e);let t="";this.channelInfo.callInfo.connectionId!==null&&(t=this.channelInfo.callInfo.connectionId),ipron.ClearCall(this.channelInfo.extension,t,0,0),this.applyEventHandlerPromise(n)})}hold(){return this.pushCommand(e=>{E.log("[counsel-flow-hub/voice/ipron] hold");let n="";this.channelInfo.callInfo.connectionId!==null&&(n=this.channelInfo.callInfo.connectionId),ipron.HoldCall(this.channelInfo.extension,n,0,0),this.applyEventHandlerPromise(e)})}retrieve(){return this.pushCommand(e=>{E.log("[counsel-flow-hub/voice/ipron] retrieve");let n="";this.channelInfo.callInfo.connectionId!==null&&(n=this.channelInfo.callInfo.connectionId),ipron.RetrieveCall(this.channelInfo.extension,n,0,0),this.applyEventHandlerPromise(e)})}hangup(){return this.pushCommand(e=>{E.log("[counsel-flow-hub/voice/ipron] hangup");let n="";this.channelInfo.callInfo.connectionId!==null&&(n=this.channelInfo.callInfo.connectionId),ipron.ClearCall(this.channelInfo.extension,n,0,0),this.applyEventHandlerPromise(e)})}consult(e,n,t){return this.pushCommand(l=>{E.log("[counsel-flow-hub/voice/ipron] consult : ",e,n,t);const s=ipron.EXTCreateExtension();ipron.EXTAddRecord(s,"xferData",JSON.stringify(this.channelInfo.callInfo)),e.extraData!==void 0&&e.extraData!==null&&S.addExtraData(s,e.extraData);const a=S.makeDialData(e);ipron.MakeCall(this.channelInfo.extension,e.calledId,a.obCallingDn,a.skillLevel,a.priority,a.relationAgentDn,a.relationAgentId,a.relationMethod,a.routeMethod,a.routeSkillId,a.routeGroupId,a.Ucid,s,0,a.usePrevAgent,a.useDesignatedAgent,a.relationTimeout),this.applyEventHandlerPromise(l)})}transfer(e){return this.pushCommand(n=>{if(E.log("[counsel-flow-hub/voice/ipron] transfer : dial=>",e),this.channelInfo.callInfo.callType===CounselFlowHubVoiceCode.CallType.CONSULT){let t=0;e.extraData!==void 0&&e.extraData!==null&&(t=ipron.EXTCreateExtension(),S.addExtraData(t,e.extraData)),ipron.MuteTransfer(this.channelInfo.extension,this.channelInfo.callInfo.xferConnectionId,e.calledId,t,0)}else{let t="";this.channelInfo.callInfo.connectionId!==null&&(t=this.channelInfo.callInfo.connectionId);const l=ipron.EXTCreateExtension();ipron.EXTAddRecord(l,"direct",JSON.stringify({type:"TRANSFER"})),ipron.EXTAddRecord(l,"xferData",JSON.stringify(this.channelInfo.callInfo)),e.extraData!==void 0&&e.extraData!==null&&S.addExtraData(l,e.extraData);const s=S.makeDialData(e);ipron.SinglestepTransfer(this.channelInfo.extension,t,e.calledId,s.obCallingDn,s.skillLevel,s.priority,s.relationAgentDn,s.relationAgentId,s.relationMethod,s.routeMethod,s.routeSkillId,s.routeGroupId,l,0,s.usePrevAgent,s.useDesignatedAgent,s.relationTimeout)}this.applyEventHandlerPromise(n)})}conference(e){return this.pushCommand(n=>{if(E.log("[counsel-flow-hub/voice/ipron] conference: dial=>",e),this.channelInfo.callInfo.callType===CounselFlowHubVoiceCode.CallType.CONSULT){let t=0;e.extraData!==void 0&&e.extraData!==null&&(t=ipron.EXTCreateExtension(),S.addExtraData(t,e.extraData));const l=S.makeDialData(e);ipron.Conference(this.channelInfo.extension,this.channelInfo.callInfo.xferConnectionId,this.channelInfo.callInfo.calledId,l.obCallingDn,l.partyType,t,0)}else{let t="";this.channelInfo.callInfo.connectionId!==null&&(t=this.channelInfo.callInfo.connectionId);const l=ipron.EXTCreateExtension();ipron.EXTAddRecord(l,"direct",JSON.stringify({type:"CONFERENCE"})),ipron.EXTAddRecord(l,"xferData",JSON.stringify(this.channelInfo.callInfo)),e.extraData!==void 0&&e.extraData!==null&&S.addExtraData(l,e.extraData);const s=S.makeDialData(e);ipron.SinglestepConference(this.channelInfo.extension,t,e.calledId,s.obCallingDn,s.partyType,l,0)}this.applyEventHandlerPromise(n)})}getFetcher(){return this.fetcher}checkQueueAndCommand(){if(this.commandQueue.length===0){setTimeout(this.checkQueueAndCommand.bind(this),50);return}const e=this.commandQueue.splice(0,1);e[0].func(e[0].promiseObject)}pushCommand(e){const n={promise:null,resolve:null,reject:null};return n.promise=new Promise(function(t,l){n.resolve=t,n.reject=l}),this.commandQueue.push({func:e,promiseObject:n}),n.promise}applyEventHandlerPromise(e){this.eventHandler.newPromise().then(function(n){e.resolve(n)}).catch(function(n){e.reject(n)}).finally(function(){this.checkQueueAndCommand()}.bind(this))}static makeDialData(e){const n=e.obCallingDn!==void 0?e.obCallingDn:"",t=e.skillLevel!==void 0?e.skillLevel:0,l=e.priority!==void 0?e.priority:0,s=e.relationAgentDn!==void 0?e.relationAgentDn:"",a=e.relationAgentId!==void 0?e.relationAgentId:"",h=e.relationMethod!==void 0?e.relationMethod:0,I=e.routeMethod!==void 0?e.routeMethod:0,N=e.routeSkillId!==void 0?e.routeSkillId:0,P=e.routeGroupId!==void 0?e.routeGroupId:0,Y=e.Ucid!==void 0?e.Ucid:"",K=e.usePrevAgent!==void 0?e.usePrevAgent:0,W=e.useDesignatedAgent!==void 0?e.useDesignatedAgent:0,J=e.relationTimeout!==void 0?e.relationTimeout:0,X=e.partyType!==void 0?e.partyType:1;return{obCallingDn:n,skillLevel:t,priority:l,relationAgentDn:s,relationAgentId:a,relationMethod:h,routeMethod:I,routeSkillId:N,routeGroupId:P,Ucid:Y,usePrevAgent:K,useDesignatedAgent:W,relationTimeout:J,partyType:X}}static addExtraData(e,n){Object.keys(n).forEach(function(l){ipron.EXTAddRecord(e,l,n[l])})}}class F{static create(e){if(e===CounselFlowHubVoiceType.ETS_FINESSE)return new U(e);if(e===CounselFlowHubVoiceType.ETS_FINESSE_V2)return new U(e);if(e===CounselFlowHubVoiceType.IPRON_V5)return new S(e);m.error("[counsel-flow-hub/voice] not support voice type : ",e)}static getSupportedChannelTypes(){const e=[];return e.push(CounselFlowHubVoiceType.ETS_FINESSE),e.push(CounselFlowHubVoiceType.ETS_FINESSE_V2),e.push(CounselFlowHubVoiceType.IPRON_V5),e}static isSupportedChannelType(e){return CounselFlowHubVoiceType[e]!==void 0}}window.CounselFlowHubChatType=Object.freeze({EMC_ECC:"EMC_ECC"});window.CounselFlowHubChatCode=Object.freeze(Object.assign({},CounselFlowHubCode,{ChannelState:{NOTLOGIN:"NOTLOGIN",READY:"READY",ABSENCE:"ABSENCE",PROCESS:"PROCESS",OFFERING:"OFFERING"},ChatState:{WAIT_ACCEPT:"WAIT_ACCEPT",CHATTING:"CHATTING",STANDBY:"STANDBY",HOLD:"HOLD",TRANSFERRING:"TRANSFERRING",PROCESS:"PROCESS",FINISH:"FINISH"}}));class le extends _{constructor(){super(),this.state=CounselFlowHubChatCode.ChannelState.NOTLOGIN,this.subState=null,this.chatRoomInfos=new Map}}class se extends G{constructor(e){super(e),this.channelInfo=new le}addChatMessageEventCallback(e){}removeChatMessageEventCallback(e){}occurChatEvent(e){}accept(e){}reject(e){}join(e,n){}hold(e,n){}retrieve(e,n){}exit(e){}transfer(e,n){}cancelTransfer(e){}eccConnect(){}eccLogin(){}sendMessage(e,n){}getList(e){}getMessages(e,n){}}class ae{constructor(){this.type=null,this.id=null,this.state=null,this.inboundPath=null,this.connectionId=null,this.startDate=null,this.members=null,this.isAccepting=!1,this.xferMemberId=null,this.xferConnectionId=null,this.xferMessage=null}}class j{constructor(){this.type=null,this.id=null,this.name=null}}class C extends x{}class y extends u{constructor(e){super(e)}onResultEvent(e){const n=u.parseData(e);if(C.log("[counsel-flow-hub/chat/emc] onResultEvent : ",n),(!n.msg||!n.msg.contact_type||n.msg.contact_type!=="CHAT")&&!(n.cmd==="LOGIN"||n.cmd==="LOGOUT"))return this.occurReject(u.convertError(n,this.channel.channelType));if(n.ret==="0"||n.ret===0){if(n.cmd==="DROP"&&n.msg.state==="QUEUING"&&this.channel.channelInfo.chatRoomInfos.delete(n.msg.mm_contact_id),n.cmd==="EVT_TRANSFER"){n.msg.state=CounselFlowHubChatCode.ChatState.TRANSFERRING,this.onCallEvent(n);return}else n.cmd==="EVT_TRANSFER_CANCEL"&&this.onCallEvent(n);this.channel.channelInfo.subState=n.cmd==="NOT_READY"||n.cmd==="SET_STATUS"?n.msg.reason_code:"",this.occurResolve(n.msg)}else if(n.ret==="1"||n.ret===1){if(n.cmd==="CONTACT_LIST")return;this.occurReject(u.convertError(n,this.channel.channelType))}else this.occurReject(u.convertError(n,this.channel.channelType))}onAgentEvent(e){const n=u.parseData(e);C.log("[counsel-flow-hub/chat/emc] onAgentEvent : ",n),!(!n.msg||!n.msg.contact_type||n.msg.contact_type!=="CHAT")&&(n.ret==="0"||n.ret===0?(this.channel.channelInfo.state=y.parseChannelState(n.msg.state),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))):this.occurReject(u.convertError(n,this.channel.channelType)))}onCallEvent(e){const n=u.parseData(e);if(C.log("[counsel-flow-hub/chat/emc] onCallEvent : ",n),!(!n.msg||!n.msg.contact_type||n.msg.contact_type!=="CHAT"))if(n.ret==="0"||n.ret===0){const t=y.parseChatRoomInfo(this.channel,n.msg);if(!t)return;switch(t.state){case CounselFlowHubChatCode.ChatState.WAIT_ACCEPT:case CounselFlowHubChatCode.ChatState.CHATTING:case CounselFlowHubChatCode.ChatState.STANDBY:case CounselFlowHubChatCode.ChatState.HOLD:case CounselFlowHubChatCode.ChatState.PROCESS:case CounselFlowHubChatCode.ChatState.TRANSFERRING:this.channel.channelInfo.chatRoomInfos.set(t.id,t);break;case CounselFlowHubChatCode.ChatState.FINISH:this.channel.channelInfo.chatRoomInfos.delete(t.id);break}this.channel.channelInfo.state=y.parseChannelStateByChatRoomInfos(this.channel,this.channel.channelInfo.chatRoomInfos),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))}else this.occurReject(u.convertError(n,this.channel.channelType))}onErrorEvent(e){const n=u.parseData(e);C.log("[counsel-flow-hub/chat/emc] onErrorEvent : ",n)}static parseChannelState(e){return e==="LOGIN"||e==="NOTREADY"?CounselFlowHubChatCode.ChannelState.ABSENCE:e==="READY"?CounselFlowHubChatCode.ChannelState.READY:e==="LOGOUT"?CounselFlowHubChatCode.ChannelState.NOTLOGIN:e==="ACW"?CounselFlowHubChatCode.ChannelState.PROCESS:CounselFlowHubChatCode.ChannelState.NOTLOGIN}static parseChannelStateByChatRoomInfos(e,n){let t=!1;return n&&n.size>0&&n.forEach(l=>{l.state===CounselFlowHubChatCode.ChatState.WAIT_ACCEPT&&(t=!0)}),t?CounselFlowHubChatCode.ChannelState.OFFERING:e.channelInfo.state===CounselFlowHubChatCode.ChannelState.OFFERING?CounselFlowHubChatCode.ChannelState.READY:e.channelInfo.state}static parseChatState(e,n,t){return e==="ALERTING"?CounselFlowHubChatCode.ChatState.WAIT_ACCEPT:e==="CONNECTED"&&n==="ON"&&(t===""||t==="OFF")?CounselFlowHubChatCode.ChatState.CHATTING:e==="CONNECTED"&&n==="OFF"&&(t===""||t==="OFF")?CounselFlowHubChatCode.ChatState.STANDBY:e==="CONNECTED"&&n==="ON"&&t==="ON"?CounselFlowHubChatCode.ChatState.HOLD:e==="ACW"?CounselFlowHubChatCode.ChatState.PROCESS:e==="ETS_RELEASE"||e==="RELEASE"?CounselFlowHubChatCode.ChatState.FINISH:e}static parseChatRoomInfo(e,n){const t=u.parseData(n.customer_data);let l=e.channelInfo.chatRoomInfos.get(n.mm_contact_id);if(l||(l=new ae),n.flag_is_transfer==="ON"&&n.transfer_agent===""||n.flag_is_transfer===""||n.flag_is_transfer==="OFF"){if(n.state==="QUEUING")return;if(e.channelInfo.chatRoomInfos.get(n.mm_contact_id)?l=e.channelInfo.chatRoomInfos.get(n.mm_contact_id):(l.connectionId=n.cti_contact_id,l.startDate=t.TIME_OPEN),n.call_type==="TRANS_COMPLETE"&&n.state==="RELEASE"&&l.connectionId!==n.cti_contact_id)return null;l.type=t.METHOD_NAME,l.inboundPath=n.skill,l.id=n.mm_contact_id,l.state=y.parseChatState(n.state,n.flag_active,n.flag_hold),l.xferMessage=t.transferMessage;let s=[],a=new j;a.type="AGENT",a.id=n.agent,s.push(a);let h=new j;h.type="CUSTOMER",h.id=t.MEMBER_KEY,s.push(h),l.members=s,l.state==="ETS_ACCEPT"&&n.flag_is_transfer==="OFF"&&(n.call_type===""||n.call_type==="NONE"||n.call_type==="TRANS_COMPLETE")&&e.join(l).then(function(){}.bind(this))}else n.flag_is_transfer==="ON"&&n.transfer_agent!==""&&(n.state==="RESERVED"||n.state==="ALERTING"?(l.state=CounselFlowHubChatCode.ChatState.TRANSFERRING,l.xferMessage=t.transferMessage):n.state==="ETS_ACCEPT"?(l.xferConnectionId=n.cti_contact_id,e.transferComplete(l).then(function(){}.bind(this))):(n.state==="ETS_RELEASE"||n.state==="RELEASE")&&(l.state=CounselFlowHubChatCode.ChatState.CHATTING));return l}}class oe{constructor(){this.roomId=null,this.senderType=null,this.senderId=null,this.messageType=null,this.message=null,this.extraData=null,this.sendDateTime=null}}class b{constructor(e){this.channel=e,this.serverPromise={resolve:null,reject:null},this.commandPromise={resolve:null,reject:null}}newPromise(e){return new Promise(function(n,t){e==="server"?(this.serverPromise.resolve=n,this.serverPromise.reject=t):(this.commandPromise.resolve=n,this.commandPromise.reject=t)}.bind(this))}occurResolve(e,n){n==="server"?(this.serverPromise.resolve!==null&&this.serverPromise.resolve(e),this.serverPromise.resolve=null,this.serverPromise.reject=null):(this.commandPromise.resolve!==null&&this.commandPromise.resolve(e),this.commandPromise.resolve=null,this.commandPromise.reject=null)}occurReject(e,n){n==="server"?(this.serverPromise.reject!==null&&this.serverPromise.reject(e),this.serverPromise.resolve=null,this.serverPromise.reject=null):(this.commandPromise.reject!==null&&this.commandPromise.reject(e),this.commandPromise.resolve=null,this.commandPromise.reject=null)}onServerEvent(e){C.log("[counsel-flow-hub/chat/ecc] onServerEvent=>",e),e==="Connected"?this.occurResolve("connected","server"):e==="Disconnected"&&this.occurResolve("disconnected","server")}onCommandEvent(e,n,t,l,s,a){if(C.log("[counsel-flow-hub/chat/ecc] onCommandEvent=>",e,n,t,l,s,a),(t==="8223"||t===8223)&&a){let h=[];if(a=b.parseData(a),!Array.isArray(a))return;a.forEach(I=>{(I.member_type==="KAKAO"||I.member_type==="NAVER")&&(I.member_type="CUSTOMER");const N={memberType:I.member_type,senderKey:I.sender_key,roomKey:I.room_key,memberKey:I.member_key,chatMessage:I.message,extraData:I.message_extra,messageType:I.message_type,timestamp:I.time_last_modify},P=b.parseChatRoomMessage(N);h.push(P)}),this.channel.occurChatEvent(h)}else{const h={type:"ECC",channelType:this.channel.channelType,channelInfo:this.channel.channelInfo,messageType:e,sequence:n,massageIdCommand:t,returnIE:l,resultCause:s};l===1||l==="1"?this.occurResolve(h):this.occurReject(b.convertError(CounselFlowHubChatType))}}onReceiveMessageEvent(e){const n=b.parseChatRoomMessage(e);C.log("[counsel-flow-hub/chat/ecc] onReceiveMessageEvent=>",n);let t=[];t.push(n),this.channel.occurChatEvent(t)}static parseData(e){return typeof e=="string"?JSON.parse(e):e}static parseChatRoomMessage(e){let n=new oe;return n.roomId=e.roomKey,n.senderType=e.memberType,n.senderId=e.senderKey,n.messageType=e.messageType.toUpperCase(),n.message=e.chatMessage,(n.messageType==="LINK"||n.messageType==="LINKIMAGE")&&e.extraData&&(n.extraData=b.parseData(e.extraData)),n.sendDateTime=e.timestamp,e.senderKey==="0000000000"&&(n.senderType="SYSTEM",n.senderId="SYSTEM"),n}static convertError(e){const n=r.UNKNOWN_ERROR;return n.original={code:"-9999",message:""},new r(e,n)}}b.getInstance=function(o){return window.counselFlowHubChatChannelEccEventHandler||(window.counselFlowHubChatChannelEccEventHandler=new b(o)),window.counselFlowHubChatChannelEccEventHandler};window.OnEccLinkState=function(o){C.log("[counsel-flow-hub/chat/ecc] OnEccLinkState=>",o),b.getInstance().onServerEvent(o)};window.OnEccMessage=function(o,e,n,t,l,s,a,h){C.log("[counsel-flow-hub/chat/ecc] OnEccMessage=>",o,e,n,t,l,s,a,h),(o==="KAKAO"||o==="NAVER")&&(o="CUSTOMER");const I={memberType:o,senderKey:e,roomKey:n,memberKey:t,chatMessage:l,extraData:s,messageType:a,timestamp:h};b.getInstance().onReceiveMessageEvent(I)};window.OnEccReturn=function(o,e,n,t,l,s){C.log("[counsel-flow-hub/chat/ecc] OnEccReturn=>",o,e,n,t,l,s),b.getInstance().onCommandEvent(o,e,n,t,l,s)};window.OnEccClose=function(o){C.log("[counsel-flow-hub/chat/ecc] OnEccClose=>",o)};window.AddShowLog=function(o,e){};class ie extends se{constructor(e){super(e),require("../../../../../externals/ecclib"),this.emcEventHandler=new y(this),c.getInstance().addEmcHandler(this.emcEventHandler),this.chatMaxCount=null,this.eccConnected=!1,this.eccLogined=!1,this.eccEventCallbacks=[],this.eccEventHandler=b.getInstance(this)}addChatMessageEventCallback(e){e&&this.eccEventCallbacks.unshift(e)}removeChatMessageEventCallback(e){if(e){let n=this.eccEventCallbacks.indexOf(e);n>=0&&this.eccEventCallbacks.splice(n,1)}}occurChatEvent(e){this.eccEventCallbacks.forEach(function(n){n(e)})}connect(){if(C.log("[counsel-flow-hub/chat/emc] connect"),!this.options)throw new Error("[counsel-flow-hub/chat/emc] you must set options");return c.getInstance().getEtsClient().setServerInfo(this.options.activeServer,this.options.activePort,this.options.standbyServer,this.options.standbyPort,this.options.enableSsl),c.getInstance().connect(),this.emcEventHandler.newPromise("server").then(()=>{if(!this.eccConnected)return this.eccConnect()}).then(e=>{e==="connected"?this.eccConnected=!0:e==="disconnected"&&(this.eccConnected=!1)})}eccConnect(){if(C.log("[counsel-flow-hub/chat/ecc] connect =>",this.channelInfo.id),!this.options||!this.channelInfo.id)throw new Error("[counsel-flow-hub/chat/ecc] connect invalid options or cti login id");return __m_ecc_agent_id=this.channelInfo.id,this.options.enableSsl?__m_ecc_socket_url="wss://"+this.options.eccServer+":"+this.options.eccPort:__m_ecc_socket_url="ws://"+this.options.eccServer+":"+this.options.eccPort,JS_ECC_ConnectToServer(this.channelInfo.id),this.eccEventHandler.newPromise("server").then(e=>{if(e==="connected")return this.eccConnected=!0,this.eccLogin()}).then(e=>{this.eccLogined=!0})}disconnect(){return C.log("[counsel-flow-hub/chat/emc] disconnect"),c.getInstance().disconnect(),this.emcEventHandler.newPromise("server").then(()=>{if(this.eccConnected)return JS_ECC_DisConnectToServer(),this.eccEventHandler.newPromise("server")}).then(()=>{this.eccConnected=!1})}login(e){if(C.log("[counsel-flow-hub/chat/emc] login : channelInfo=>",e),!e||!this.options)throw new Error("[counsel-flow-hub/chat/ets] invalid channelInfo or options");return e.id&&(this.channelInfo.id=e.id,__m_ecc_agent_id=this.channelInfo.id),c.getInstance().getEtsClient().EMC_login(this.channelInfo.id),this.emcEventHandler.newPromise().then(n=>{this.channelInfo.state=y.parseChannelState(n.state)}).then(()=>{if(this.eccConnected){if(this.eccConnected&&!this.eccLogined)return this.eccLogin();this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}else return this.eccConnect()}).then(()=>{this.eccLogined=!0,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}eccLogin(){if(C.log("[counsel-flow-hub/chat/ecc] login =>",this.channelInfo.id),!this.channelInfo.id)throw new Error("[counsel-flow-hub/chat/ecc] invalid channelInfo.id");return JS_ECC_Login(),this.eccEventHandler.newPromise()}logout(e){return C.log("[counsel-flow-hub/chat/emc] logout : reasonCode=>",e),c.getInstance().getEtsClient().EMC_logout(),this.emcEventHandler.newPromise().then(()=>{this.channelInfo.state=CounselFlowHubChatCode.ChannelState.NOTLOGIN,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}ready(){let e=3;return this.options&&(e=this.options.chatMaxCount),C.log("[counsel-flow-hub/chat/emc] ready=>",e),c.getInstance().getEtsClient().EMC_ready("CHAT",e),this.emcEventHandler.newPromise().then(()=>{if(this.channelInfo.state=CounselFlowHubChatCode.ChannelState.READY,this.eccConnected){if(this.eccConnected&&!this.eccLogined)return this.eccLogin();this.occurEvent(new i(this.channelType,this.channelInfo,new Date))}else return this.eccConnect()}).then(()=>{this.eccLogined=!0,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}absence(e){return C.log("[counsel-flow-hub/chat/emc] absense : reasonCode=>",e),c.getInstance().getEtsClient().EMC_notReady("CHAT",e),this.emcEventHandler.newPromise().then(()=>{this.channelInfo.state=CounselFlowHubChatCode.ChannelState.ABSENCE,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}accept(e){return C.log("[counsel-flow-hub/chat/ets] acceptChat : contactId=>",e),c.getInstance().getEtsClient().EMC_accept(e.connectionId,"CHAT"),this.emcEventHandler.newPromise().then(()=>{this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}reject(e){return C.log("[counsel-flow-hub/chat/ets] rejectChat : contactId=>",e.connectionId),c.getInstance().getEtsClient().EMC_release(e.connectionId),this.emcEventHandler.newPromise().then(()=>{this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}join(e,n){return C.log("[counsel-flow-hub/chat/ets] joinChatRoom : roomKey=>",e.id),(!n||!n.isManager||!n.enableChat)&&(n={isManager:"OFF",enableChat:"OFF"}),JS_ECC_Join(e.id,n.isManager,n.enableChat),this.eccEventHandler.newPromise()}standbyChat(e,n){return C.log("[counsel-flow-hub/chat/ets] standbyChatRoom : roomKey=>",e.id),(!n||!n.isManager)&&(n={isManager:"OFF"}),JS_ECC_Hold(e.id,n.isManager,"OFF","OFF"),this.eccEventHandler.newPromise()}activeChat(e,n){return C.log("[counsel-flow-hub/chat/ets] activeChatRoom : roomKey=>",e.id),(!n||!n.isManager)&&(n={isManager:"OFF"}),JS_ECC_Hold(e.id,n.isManager,"ON","OFF"),this.eccEventHandler.newPromise()}hold(e,n){return C.log("[counsel-flow-hub/chat/ets] holdChatRoom : roomKey=>",e.id),(!n||!n.isManager)&&(n={isManager:"OFF"}),JS_ECC_Hold(e.id,n.isManager,"ON","ON"),this.eccEventHandler.newPromise()}retrieve(e,n){return C.log("[counsel-flow-hub/chat/ets] retrieveChatRoom : roomKey=>",e.id),(!n||!n.isManager)&&(n={isManager:"OFF"}),JS_ECC_Hold(e.id,n.isManager,"ON","OFF"),this.eccEventHandler.newPromise()}exit(e){return C.log("[counsel-flow-hub/chat/ets] exitChatRoom : roomKey=>",e.id),JS_ECC_Exit(e.id),this.eccEventHandler.newPromise()}transfer(e,n){if(C.log("[counsel-flow-hub/chat/ets] transfer : chatRoomInfo =>",e),C.log("[counsel-flow-hub/chat/ets] transfer : options =>",n),!n)throw new Error("[counsel-flow-hub/chat/ets] transfer : invalid options");return n.type==="AGENT"?c.getInstance().getEtsClient().EMC_transferToAgent(n.targetAgentId,e.connectionId,JSON.stringify(n)):n.type==="SKILL"&&c.getInstance().getEtsClient().EMC_transfer(n.targetSkill,e.connectionId,JSON.stringify(n)),this.emcEventHandler.newPromise()}sendMessage(e,n){return C.log("[counsel-flow-hub/chat/ets] send Message : roomKey / Message=>",e.id,n.messageType,n.message,n.extraDatas),n.extraDatas?n.extraDatas=JSON.stringify(n.extraDatas):n.extraDatas="",n.extraDatas&&!n.message&&(n.message=""),JS_ECC_SendMessage(n.message,e.id,n.messageType,n.extraDatas),this.eccEventHandler.newPromise()}getList(e){return C.log("[counsel-flow-hub/chat/ets] get contact list"),c.getInstance().getEtsClient().EMC_getContactList(),this.emcEventHandler.newPromise()}getMessages(e,n){return C.log("[counsel-flow-hub/chat/ets] get message list=>",e.id,n.page,n.countPerPage),JS_ECC_GetMessageList(e.id,n.page,n.countPerPage),this.eccEventHandler.newPromise().then(t=>{this.occurChatEvent(t)})}transferComplete(e){return C.log("[counsel-flow-hub/chat/ets] transferComplete : contactId=>",e.connectionId),c.getInstance().getEtsClient().EMC_transferComplete(e.connectionId),this.emcEventHandler.newPromise()}cancelTransfer(e){return C.log("[counsel-flow-hub/chat/ets] cancelTransfer : contactId=>",e.connectionId),c.getInstance().getEtsClient().EMC_transferCancel(e.connectionId),this.emcEventHandler.newPromise()}}class M{static create(e){if(e===CounselFlowHubChatType.EMC_ECC)return new ie(e);C.error("[counsel-flow-hub/chat] not support chat type : ",e)}static getSupportedChannelTypes(){const e=[];return e.push(CounselFlowHubChatType.EMC_ECC),e}static isSupportedChannelType(e){return CounselFlowHubChatType[e]!==void 0}}window.CounselFlowHubMailType=Object.freeze({EMC_ECM:"EMC_ECM"});window.CounselFlowHubMailCode=Object.freeze(Object.assign({},CounselFlowHubCode,{ChannelState:{NOTLOGIN:"NOTLOGIN",READY:"READY",ABSENCE:"ABSENCE",PROCESS:"PROCESS",OFFERING:"OFFERING"},MailState:{WAIT_ACCEPT:"WAIT_ACCEPT",CONNECTED:"CONNECTED",PROCESS:"PROCESS",TRANSFERRING:"TRANSFERRING",COMPLETE_TRANSFER:"COMPLETE_TRANSFER",FAILED_TRANSFER:"FAILED_TRANSFER",FINISH:"FINISH"}}));class ce extends _{constructor(){super(),this.state=CounselFlowHubMailCode.ChannelState.NOTLOGIN,this.subState=null,this.mailInfos=new Map}}class re extends G{constructor(e){super(e),this.channelInfo=new ce}acceptMail(e){}rejectMail(e){}sendNewMail(e){}replyMail(e){}uploadFiles(e,n){}}class g extends x{}class he{constructor(){this.type=null,this.state=null,this.inboundPath=null,this.connectionId=null,this.ctiContactId=null,this.mailId=null,this.extraData=null,this.subject=null,this.content=null,this.attachments=null,this.sender=null,this.recipients=null,this.ccRecipients=null,this.bccRecipients=null,this.dateTime=null,this.isMiddleReply=!1,this.isForward=!1}}class k{constructor(){this.type=null,this.fileName=null,this.fileUrl=null,this.fileDomain=null,this.filePath=null}}class T extends u{constructor(e){super(e)}onResultEvent(e){const n=u.parseData(e);if(g.log("[counsel-flow-hub/mail/emc] onResultEvent : ",n),(!n.msg||!n.msg.contact_type||n.msg.contact_type!=="EMAIL")&&!(n.cmd==="LOGIN"||n.cmd==="LOGOUT"))return this.occurReject(u.convertError(n,this.channel.channelType));if(n.ret==="0"||n.ret===0){if(n.cmd==="DROP"&&this.onCallEvent(e),n.cmd==="EVT_TRANSFER_CANCEL")return this.onCallEvent(e);this.channel.channelInfo.subState=n.cmd==="NOT_READY"||n.cmd==="SET_STATUS"?n.msg.reason_code:"",this.occurResolve(n.msg)}else if(n.ret==="1"||n.ret===1){if(n.cmd==="CONTACT_LIST")return;this.occurReject(u.convertError(n,this.channel.channelType))}else this.occurReject(u.convertError(n,this.channel.channelType))}onAgentEvent(e){const n=u.parseData(e);g.log("[counsel-flow-hub/mail/emc] onAgentEvent : ",n),!(!n.msg||!n.msg.contact_type||n.msg.contact_type!=="EMAIL")&&(n.ret==="0"||n.ret===0?(this.channel.channelInfo.state=T.parseChannelState(n.msg.state),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))):this.occurReject(u.convertError(n,this.channel.channelType)))}async onCallEvent(e){const n=u.parseData(e);if(g.log("[counsel-flow-hub/mail/emc] onCallEvent : ",n),!(!n.msg||!n.msg.contact_type||n.msg.contact_type!=="EMAIL"))if(n.ret==="0"||n.ret===0){let t=this.parseEmcEventToMailInfo(this.channel,n.msg);switch(t.state){case CounselFlowHubMailCode.MailState.WAIT_ACCEPT:this.channel.channelInfo.mailInfos.set(t.connectionId,t),this.channel.channelInfo.state=this.parseChannelStateByMailInfos(this.channel,this.channel.channelInfo.mailInfos),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date));break;case CounselFlowHubMailCode.MailState.CONNECTED:case CounselFlowHubMailCode.MailState.PROCESS:if(!t.mailId){const l=await this.getMailDetail(t);if(!l){this.channel.channelInfo.mailInfos.set(t.connectionId,t),this.occurReject(u.convertError(n,this.channel.channelType));break}t=this.parseEcmEntityToMailInfo(t,l)}this.channel.channelInfo.mailInfos.set(t.connectionId,t),this.channel.channelInfo.state=this.parseChannelStateByMailInfos(this.channel,this.channel.channelInfo.mailInfos),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date));break;case CounselFlowHubMailCode.MailState.TRANSFERRING:case CounselFlowHubMailCode.MailState.FAILED_TRANSFER:this.channel.channelInfo.mailInfos.set(t.connectionId,t),this.channel.channelInfo.state=this.parseChannelStateByMailInfos(this.channel,this.channel.channelInfo.mailInfos),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date));break;case CounselFlowHubMailCode.MailState.COMPLETE_TRANSFER:this.channel.channelInfo.mailInfos.set(t.connectionId,t),this.channel.channelInfo.state=this.parseChannelStateByMailInfos(this.channel,this.channel.channelInfo.mailInfos),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date)),this.channel.transferComplete(t).then(()=>{this.channel.rejectMail(t).then(()=>{this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date))})});break;case CounselFlowHubMailCode.MailState.FINISH:this.channel.channelInfo.mailInfos.delete(t.connectionId),this.channel.channelInfo.state=this.parseChannelStateByMailInfos(this.channel,this.channel.channelInfo.mailInfos),this.channel.occurEvent(new i(this.channel.channelType,this.channel.channelInfo,new Date));break}}else this.occurReject(u.convertError(n,this.channel.channelType))}onErrorEvent(e){const n=u.parseData(e);g.log("[counsel-flow-hub/mail/emc] onErrorEvent : ",n)}getMailDetail(e){return new Promise((n,t)=>{$.ajax({url:e.extraData.contentUrl,contentType:"application/json",type:"GET",data:null,cache:!1,processData:!1,success:function(l){l&&l.resCode==="9999"?(g.error("[counsel-flow-hub/mail/emc] getMailDetail Error : ",l.resMsg),n()):n(l)},error:function(l){n()}})})}parseEcmEntityToMailInfo(e,n){return e.mailId=n.email_id,e.ctiContactId=n.cti_contact_id,e.subject=n.content_title,e.content=n.content_body,e.sender=n.sender,e.recipients=n.receiver?n.receiver.split(";"):null,e.ccRecipients=n.receiver_cc?n.receiver_cc.split(";"):null,e.bccRecipients=n.receiver_bcc?n.receiver_bcc.split(";"):null,e.dateTime=n.received_time,e.attachments=[],n.content_attach&&n.content_attach.length>0&&n.content_attach.forEach(t=>{let l=new k;l.type=t.attach_type,l.fileName=t.file_name,l.fileUrl=t.attach_url,l.filePath=t.file_path,e.attachments.push(l)}),e}parseEmcEventToMailInfo(e,n){const t=u.parseData(n.customer_data),l=n.mm_contact_id.replace("EMAIL","");let s=e.channelInfo.mailInfos.get(l);return s||(s=new he),s.type=n.contact_type,s.state=this.parseMailState(e,n),s.inboundPath=t.SKILL,s.connectionId=l,!(s.state===CounselFlowHubMailCode.MailState.TRANSFERRING||s.state===CounselFlowHubMailCode.MailState.FAILED_TRANSFER)&&!s.ctiContactId&&(s.ctiContactId=n.cti_contact_id),s.extraData=t,s.extraData.inboundDate=t.TIME_OPEN,s.extraData.listUrl=t.LIST_URL,s.extraData.contentUrl=t.CONTANT_URL,s.extraData.sendUrl=t.SEND_URL,s.extraData.uploadUrl=t.UPLOAD_URL,s}parseMailState(e,n){return n.state==="RESERVED"||n.state==="ALERTING"?n.call_type==="TRANS"&&n.transfer_agent!==""?CounselFlowHubMailCode.MailState.TRANSFERRING:CounselFlowHubMailCode.MailState.WAIT_ACCEPT:n.state==="ETS_CONNECT"||n.state==="CONNECTED"?n.call_type==="TRANS"&&n.transfer_agent!==""?CounselFlowHubMailCode.MailState.COMPLETE_TRANSFER:CounselFlowHubMailCode.MailState.CONNECTED:n.state==="ACW"?CounselFlowHubMailCode.MailState.PROCESS:n.state==="ETS_RELEASE"||n.state==="RELEASE"?n.call_type==="TRANS_EXPIRED"&&n.transfer_agent!==""?CounselFlowHubMailCode.MailState.FAILED_TRANSFER:CounselFlowHubMailCode.MailState.FINISH:n.state}parseChannelStateByMailInfos(e,n){let t=!1;return n&&n.size>0&&n.forEach(l=>{l.state===CounselFlowHubMailCode.MailState.WAIT_ACCEPT&&(t=!0)}),t?CounselFlowHubMailCode.ChannelState.OFFERING:e.channelInfo.state===CounselFlowHubMailCode.ChannelState.OFFERING?CounselFlowHubMailCode.ChannelState.READY:e.channelInfo.state}static parseMailInfoToEcmEntity(e,n,t){let l={content_title:n.subject,agent:e,content_body:n.content,sender:n.sender,time_start:n.dateTime,time_send:null,receive_mail_id:null,cti_contact_id:null,mm_contact_id:null,receiver:null,receiver_cc:null,receiver_bcc:null,email_id:null,content_other:[]};if(n.recipients){let s="";n.recipients.forEach(a=>{s+=s!==""?`;${a}`:a}),l.receiver=s}if(n.ccRecipients){let s="";n.ccRecipients.forEach(a=>{s+=s!==""?`;${a}`:a}),l.receiver_cc=s}if(n.bccRecipients){let s="";n.bccRecipients.forEach(a=>{s+=s!==""?`;${a}`:a}),l.receiver_bcc=s}return n.attachments&&n.attachments.length>0&&n.attachments.forEach(s=>{l.content_other.push({file_name:s.fileName,type:s.type,url:{fileDomain:s.fileDomain,filePath:s.filePath,fileUrl:s.fileUrl}})}),t&&(l.receive_mail_id=`EMAIL${n.connectionId}`,l.cti_contact_id=`${n.ctiContactId}`,l.mm_contact_id=`EMAIL${n.connectionId}`,l.email_id=`${n.mailId}`,l.reply_end=n.isMiddleReply?"OFF":"ON",l.flag_forward=n.isForward?"ON":"OFF"),l}static parseEcmFileEntityToMailAttachment(e){let n=new k;return n.type=e.type,n.fileName=e.file_name,n.fileUrl=e.url.fileUrl,n.fileDomain=e.url.fileDomain,n.filePath=e.url.filePath,n}static sendNewMail(e,n,t){return new Promise((l,s)=>{const a=T.parseMailInfoToEcmEntity(e,n,!1);$.ajax({url:`${t.ecmProtocol}://${t.ecmServer}:${t.ecmPort}${t.pathPatterns.sendNewMail.path}`,contentType:t.pathPatterns.sendNewMail.contentType,type:t.pathPatterns.sendNewMail.method,data:JSON.stringify(a),cache:!1,processData:!1,success:function(h){h.resCode==="0000"?(n.dateTime=h.resDttm,n.mailId=h.email_id,l(n)):l()},error:function(h){l()}})})}static parseMailInfoToFinishNewMailEntity(e,n){return{agent:e,contact_type:"EMAIL",email_id:n.mailId,time_close:null}}static finishNewMailProcess(e,n,t){return new Promise(async(l,s)=>{const a=T.parseMailInfoToFinishNewMailEntity(e,n);$.ajax({url:`${t.ecmProtocol}://${t.ecmServer}:${t.ecmPort}${t.pathPatterns.newMailProcess.path}`,contentType:t.pathPatterns.newMailProcess.contentType,type:t.pathPatterns.newMailProcess.method,data:JSON.stringify(a),cache:!1,processData:!1,success:function(h){h.resCode==="0000"?l(n):l()},error:function(h){l()}})})}static sendReplyMail(e,n){return new Promise(async(t,l)=>{const s=T.parseMailInfoToEcmEntity(e,n,!0);$.ajax({url:n.extraData.sendUrl,contentType:"application/json",type:"POST",data:JSON.stringify(s),cache:!1,processData:!1,success:function(a){a.resCode==="0000"?(n.dateTime=a.resDttm,t(n)):t()},error:function(a){t()}})})}static uploadFile(e,n,t,l){let s=`${t.ecmProtocol}://${t.ecmServer}:${t.ecmPort}${t.pathPatterns.uploadFile.path}/${l}`;const a=`${t.pathPatterns.uploadFile.method}`;return e.extraData&&e.extraData.uploadUrl&&(s=e.extraData.uploadUrl),new Promise(async(h,I)=>{$.ajax({url:s,contentType:!1,type:a,data:n,cache:!1,processData:!1,success:function(N){if(N&&N.length===1){const P=T.parseEcmFileEntityToMailAttachment(N[0]);h(P)}else h()},error:function(N){h()}})})}static parseChannelState(e){return e==="LOGIN"||e==="NOTREADY"?CounselFlowHubMailCode.ChannelState.ABSENCE:e==="READY"?CounselFlowHubMailCode.ChannelState.READY:e==="LOGOUT"?CounselFlowHubMailCode.ChannelState.NOTLOGIN:e==="ACW"?CounselFlowHubMailCode.ChannelState.PROCESS:CounselFlowHubMailCode.ChannelState.NOTLOGIN}}class ue extends re{constructor(e){super(e),this.emcEventHandler=new T(this),c.getInstance().addEmcHandler(this.emcEventHandler)}connect(){if(g.log("[counsel-flow-hub/mail/emc] connect, options : ",this.options),!this.options)throw new Error("[counsel-flow-hub/mail/emc] you must set options");return c.getInstance().getEtsClient().setServerInfo(this.options.activeServer,this.options.activePort,this.options.standbyServer,this.options.standbyPort,this.options.enableSsl),c.getInstance().connect(),this.emcEventHandler.newPromise("server")}disconnect(){return g.log("[counsel-flow-hub/mail/emc] disconnect"),c.getInstance().disconnect(),this.emcEventHandler.newPromise("server")}login(e){if(g.log("[counsel-flow-hub/mail/emc] login : channelInfo=>",e),!e||!this.options)throw new Error("[counsel-flow-hub/chat/ets] invalid channelInfo or options");return this.channelInfo.id=e.id,c.getInstance().getEtsClient().EMC_login(e.id),this.emcEventHandler.newPromise().then(n=>{this.channelInfo.state=T.parseChannelState(n.state),this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}logout(e){return g.log("[counsel-flow-hub/mail/emc] logout : reasonCode=>",e),c.getInstance().getEtsClient().EMC_logout(),this.emcEventHandler.newPromise().then(n=>{this.channelInfo.state=CounselFlowHubMailCode.ChannelState.NOTLOGIN,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}ready(){let e=3;return this.options&&this.options.mailMaxCount&&(e=this.options.mailMaxCount),g.log("[counsel-flow-hub/mail/emc] ready",e),c.getInstance().getEtsClient().EMC_ready("EMAIL",e),this.emcEventHandler.newPromise().then(()=>{this.channelInfo.state=CounselFlowHubMailCode.ChannelState.READY,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}absence(e){return g.log("[counsel-flow-hub/mail/emc] absense : reasonCode=>",e),c.getInstance().getEtsClient().EMC_notReady("EMAIL",e),this.emcEventHandler.newPromise().then(()=>{this.channelInfo.state=CounselFlowHubMailCode.ChannelState.ABSENCE,this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}acceptMail(e){return g.log("[counsel-flow-hub/mail/emc] acceptMail : mailInfo.ctiContactId=>",e.ctiContactId),c.getInstance().getEtsClient().EMC_accept(`${e.ctiContactId}`,"EMAIL"),this.emcEventHandler.newPromise().then(()=>{this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}rejectMail(e){return g.log("[counsel-flow-hub/mail/emc] rejectMail : mailInfo.ctiContactId=>",e.ctiContactId),c.getInstance().getEtsClient().EMC_release(`${e.ctiContactId}`),this.emcEventHandler.newPromise().then(()=>{this.occurEvent(new i(this.channelType,this.channelInfo,new Date))})}transfer(e,n){if(g.log("[counsel-flow-hub/mail/emc] transfer : mailInfo =>",e),g.log("[counsel-flow-hub/mail/emc] transfer : options =>",n),!n)throw new Error("[counsel-flow-hub/mail/emc] transfer : invalid options");return n.type==="AGENT"?c.getInstance().getEtsClient().EMC_transferToAgent(n.targetAgentId,e.ctiContactId,JSON.stringify(n)):n.type==="SKILL"&&c.getInstance().getEtsClient().EMC_transfer(n.targetSkill,e.ctiContactId,JSON.stringify(n)),this.emcEventHandler.newPromise()}transferComplete(e){return g.log("[counsel-flow-hub/mail/emc] transferComplete : ctiContactId=>",e.ctiContactId),c.getInstance().getEtsClient().EMC_transferComplete(e.ctiContactId),this.emcEventHandler.newPromise()}cancelTransfer(e){return g.log("[counsel-flow-hub/mail/emc] cancelTransfer : ctiContactId=>",e.ctiContactId),c.getInstance().getEtsClient().EMC_transferCancel(e.ctiContactId),this.emcEventHandler.newPromise()}async sendNewMail(e){return g.log("[counsel-flow-hub/mail/emc] acceptMail : mailInfo=>",e),e=await T.sendNewMail(this.channelInfo.id,e,this.options),new Promise((n,t)=>{n(e)})}async finishNewMailProcess(e){return g.log("[counsel-flow-hub/mail/emc] finishNewMailProcess : mailInfo=>",e),e=await T.finishNewMailProcess(this.channelInfo.id,e,this.options),new Promise((n,t)=>{n(e)})}async replyMail(e){return g.log("[counsel-flow-hub/mail/emc] replyMail"),e=await T.sendReplyMail(this.channelInfo.id,e),new Promise((n,t)=>{n(e)})}uploadFiles(e,n){let t=[];return n.forEach(l=>{let s=new FormData;s.append("file",l),t.push(new Promise(async(a,h)=>{T.uploadFile(e,s,this.options,this.channelInfo.id).then(I=>{a(I)})}))}),Promise.all(t)}}class H{static create(e){if(e===CounselFlowHubMailType.EMC_ECM)return new ue(e);g.error("[counsel-flow-hub/mail] not support mail type : ",e)}static getSupportedChannelTypes(){const e=[];return e.push(CounselFlowHubMailType.EMC_ECM),e}static isSupportedChannelType(e){return CounselFlowHubMailType[e]!==void 0}}class fe{static create(e){const n=new Z;return e!=null&&e.forEach(function(t){F.isSupportedChannelType(t)?n.addChannel(t,F.create(t)):M.isSupportedChannelType(t)?n.addChannel(t,M.create(t)):H.isSupportedChannelType(t)&&n.addChannel(t,H.create(t))}),n}static getSupportedChannelTypes(){let e=[];return e=e.concat(F.getSupportedChannelTypes()),e=e.concat(M.getSupportedChannelTypes()),e=e.concat(H.getSupportedChannelTypes()),e}}class Ce extends x{}window.CounselFlowHubFactory=fe;window.CounselFlowHubVoiceChannelFactory=F;window.CounselFlowHubConsole=A;window.CounselFlowHubChannelConsole=x;window.CounselFlowHubChannelFetcherConsole=Ce;window.CounselFlowHubVoiceChannelConsole=m;window.CounselFlowHubVoiceChannelIpronConsole=E;function de(o){return{all:o=o||new Map,on:function(e,n){var t=o.get(e);t?t.push(n):o.set(e,[n])},off:function(e,n){var t=o.get(e);t&&(n?t.splice(t.indexOf(n)>>>0,1):o.set(e,[]))},emit:function(e,n){var t=o.get(e);t&&t.slice().map(function(l){l(n)}),(t=o.get("*"))&&t.slice().map(function(l){l(e,n)})}}}const Ie=de();let L,V;const pe=z(({app:o})=>{o.config.globalProperties.$emitter=Ie,L=CounselFlowHubFactory.create([CounselFlowHubVoiceType.IPRON_V5]),V=L.getChannel(CounselFlowHubVoiceType.IPRON_V5),V.id=CounselFlowHubVoiceType.IPRON_V5,o.config.globalProperties.$counselHub=L,o.config.globalProperties.$channel=V});export{V as channel,L as counselHub,pe as default};
