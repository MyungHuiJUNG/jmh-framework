import{d}from"./index.02f7c95d.js";import{p as c}from"./permissionApi.ffe0b82d.js";import{m as l}from"./menuApi.a7c1508d.js";import{h as u}from"./errorHandler.5efe1eb1.js";const M=d("menuStore",{state:()=>({dynamicMenuList:[],quickMenuItems:[],initialLoaded:!1}),getters:{},actions:{async buildMenuTree(r){const n={},e=[],i=r.filter(t=>t.usable);i.forEach(t=>{n[t.entityId]={name:t.code,label:t.name,icon:null,orderNumber:t.orderNumber}}),i.forEach(t=>{t.parentEntityId===null?e.push(n[t.entityId]):(n[t.parentEntityId].children||(n[t.parentEntityId].children=[]),n[t.parentEntityId].children.push(n[t.entityId]))});function o(t,s){return t.orderNumber-s.orderNumber}function a(t){t.sort(o),t.forEach(s=>{s.children&&a(s.children)})}return a(e),this.loadIcons(i,n),e},loadIcons(r,n){r.forEach(e=>{e.iconImageFile?l.getImageWithToken(e.iconImageFile.downloadUrl).then(i=>{n[e.entityId].icon=i}).catch(i=>{n[e.entityId].icon=null}):n[e.entityId].icon=null})},async getMenus(r){const n={name:"CALL_CONSULT",label:"\uC804\uD654\uC0C1\uB2F4",icon:"call",orderNumber:1};if(!r){this.dynamicMenuList=[n];return}try{const e=await c.getMenusByPermission(r);if(e.status===200){const i=await this.buildMenuTree(e.data);this.dynamicMenuList=[n,...i]}}catch(e){u(e)}},async fetchInitialData(r){const n={name:"CALL_CONSULT",label:"\uC804\uD654\uC0C1\uB2F4",icon:"call",orderNumber:1};if(!r){this.dynamicMenuList=[n],this.quickMenuItems=[];return}if(this.initialLoaded)return Promise.resolve();this.initialLoaded=!0;try{const e=await c.getMenusByPermission(r);if(e.status===200){const i=await this.buildMenuTree(e.data);this.dynamicMenuList=[n,...i];const a=this.flattenMenuItems(e.data).filter(t=>t.quickUsable===!0).sort((t,s)=>t.quickOrderNumber-s.quickOrderNumber);await this.loadquickMenuIcons(a),this.quickMenuItems=a}}catch(e){throw this.initialLoaded=!1,e}},clearInitialData(){this.initialLoaded=!1,this.dynamicMenuList=[],this.quickMenuItems=[]},flattenMenuItems(r){let n=[];return r.forEach(e=>{n.push(e),e.children&&e.children.length>0&&(n=n.concat(flattenMenuItems(e.children)))}),n},loadquickMenuIcons(r){const n=r.map(e=>e.quickIconImageFile&&e.quickIconImageFile.downloadUrl?l.getImageWithToken(e.quickIconImageFile.downloadUrl).then(i=>{e.iconUrl=i}).catch(i=>{u(i)}):(e.iconUrl=null,Promise.resolve()));return Promise.all(n)}}});export{M as u};
